const URL_BASE="http://localhost/gdagmcp",CARPETA_BASE="/base",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles,permisosDefault=[{id:"1",nombre:"Leer",status:"false"},{id:"2",nombre:"Escribir",status:"false"}];async function iniciarApp(){await dibujarPadreAndCarpetas(0)}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&(console.log("secciones",a),e(a)),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerFormularios(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"formularios"},url:URL_BASE+"/documento/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerFormulario(e){return new Promise((t,a)=>{$.ajax({data:{tipo:"formulario",id:e},url:URL_BASE+"/documento/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{a(e)})})}function traerDocs(e){return new Promise((t,a)=>{let i=[];$.ajax({data:{id:e,tipo:"documentos"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(0),$.each(e,(a,o)=>{i.push(o),e.length==a+1&&t(i)})}).fail(e=>{a(e)})})}function traerDocumento(e){return new Promise((t,a)=>{$.ajax({data:{id:e,tipo:"documento"},url:URL_BASE+"/documento/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(0),$.each(e,(e,a)=>{t(a)})}).fail(e=>{a(e)})})}function traerHijos(e=0){return new Promise((t,a)=>{let i=[];$.ajax({data:{id:e,tipo:"hijos"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(i),$.each(e,(a,o)=>{i.push(o),e.length==a+1&&t(i)})}).fail(e=>{a(e)})})}function moverCarpeta(e){return new Promise((t,a)=>{let i=[];$.ajax({data:{id:e,tipo:"updateCarpetas"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(i),$.each(e,(a,o)=>{i.push(o),e.length==a+1&&t(i)})}).fail(e=>{a(e)})})}async function dibujarAtras(e){dibujarPadreAndCarpetas((await traerSecciones()).find(t=>t.id==e).idPadre)}function hexToRgb(e){const t=e.match(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);if(t)return t.slice(1).map(e=>parseInt(e,16));const a=e.match(/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i);return a?a.slice(1).map(e=>17*parseInt(e,16)):0}function buscarCarpeta(e){document.getElementById("divBtnBuscar").innerHTML="",console.log("seecionActual",e);var t="";t+='<div class=" d-flex  justify-content-end" >',t+='<input style="width:193.5px;height:32.3px" class="form-control" id="buscarFocus" type="text" placeholder="Ingrese nombre de carpeta" onKeyUp="escucharCarpeta(this.value,'+(null!=e?e:0)+')">',t+="</div>",document.getElementById("divBtnBuscar").innerHTML=t,document.getElementById("buscarFocus").focus()}async function dibujarPadreAndCarpetas(e){await dibujarPadre(e),await dibujarHijosPadre(e)}async function dibujarPath(e){"base"!=e?$.ajax({data:{tipo:"buscarPath",value:e.replace("_"," ")},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),e.forEach(e=>{dibujarPadreAndCarpetas(e.id)})}).fail(e=>{console.log(e)}):dibujarPadreAndCarpetas(0)}async function dibujarPadre(e){var t="";let a=(await traerSecciones()).find(t=>t.id==e);if(t+='<div class="d-flex justify-content-center padreAtras">',t+='<div class="d-flex justify-content-center hijoAtras">',t+='<a class=" btn btn-outline-danger '+(null==a?"noVisible":"")+' " onclick="dibujarAtras('+e+')"><i class="fa-solid fa-arrow-left-long fa-2x"></i> <span class="span-boton">Atrás</span></a>',t+="</div>",null==a?t+='<h1 class="text-black mb-3"><strong>Administrar Carpetas</strong></h1>':(t+='<div class="d-flex flex-column justify-content-center">',t+='<div class="d-flex justify-content-center">',t+='<h1 class="text-black mb-3"><i class="fa-solid fa-folder-open fa-xl" style="margin-right:7px;color:'+a.color+'"></i><strong>'+(a.seccion[0].toUpperCase()+a.seccion.substring(1))+"</strong></h1>",t+='<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" style="margin-left:5px;margin-top:4px;width:25px;height:30px;border-radius:15px">',t+='<i class="fa-solid fa-ellipsis-vertical fa-xl "></i>',t+="</button>",t+='<ul class="dropdown-menu dropdown-menu-dark">',t+=' <li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModalEditar'+a.id+'"><i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>Editar</a></li>',t+='<li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+a.id+')"><i class="fa-solid fa-trash" style="margin-right:7px"></i>Eliminar</a></li>',t+="</ul>",t+="</div>",a.descripcion.length>0?t+='<h3 class="text-black mt-3 mb-4">'+(a.descripcion[0].toUpperCase()+a.descripcion.substring(1))+"</h3>":t+='<h3 class="text-black mt-3 mb-4">'+a.descripcion+"</h3>",t+="</div>"),t+="</div>",t+='<div class="d-flex justify-content-end mt-2">',t+='<div style="margin-right:5px" id="divBtnBuscar">',t+='<a class="btn btn-outline-primary" onclick="buscarCarpeta('+(null!=a?a.id:0)+')"><i class="fa-solid fa-magnifying-glass fa-2x"></i><span class="span-boton">Carpeta</span></a>',t+="</div>",t+="<div>",t+='<a class=" btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal'+e+'" id="'+e+'"><i class="fa-solid fa-plus fa-2x"></i><span class="span-boton">Carpeta</span></a>',t+="</div>",t+="</div>",t+='<div class="w-100 mt-2">',null!=a){let e=("/base"+a.path).split("/");e.shift();e.forEach(e=>{var a=e.replace("_"," ");t+='<a class="puntero" style="text-decoration: none !important;" onclick="dibujarPath(\''+a+"')\"><strong>"+(a[0].toUpperCase()+a.substring(1))+"</strong></a> /  "})}if(t+="</div>",t+='<div class="contenedor-carpetas mt-3 mb-5" id="contenedorCarpetas" >',t+="</div>",t+='<div class="modal fade" id="exampleModal'+e+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+=null==a?'   <h5 class="modal-title text-white">Crear Carpeta</h5>':'   <h5 class="modal-title text-white">Agregar Carpeta en '+a.seccion+"</h5>",t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body">',t+='<h3 class="text-black mt-2 mb-4">Ingresar datos de la Carpeta</h3>',t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Nombre:</strong></label>',t+='<input type="text" class="form-control" id="seccion" name="seccion" placeholder="Ingrese nombre">',t+="</div>",t+='<div class="mb-2">',t+='<label  class="form-label"><strong>Descripción:</strong></label>',t+='<textarea class="form-control" rows="5" id="descripcion" placeholder="Ingrese descripción"></textarea>',t+="</div>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Color:</strong></label>',t+='<input type="color" class="form-control w-25" id="color" name="color">',t+="</div>",t+='<div class="w-100 mt-2" id="alertas">',t+="</div>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+=null==a?'<a class="btn btn-success" id="botonCrear" onclick="createSeccion(0)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>':'<a class="btn btn-success" id="botonCrear" onclick="createSeccion('+e+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>",void 0!==a){t+='<div class="modal fade" id="exampleModalEditar'+a.id+'" tabindex="-1" aria-labelledby="exampleModalLabel'+a.id+'" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+='   <h5 class="modal-title text-white">Editar</h5>',t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body" style="min-height:350px">',t+='<h3 class="text-black mt-2 mb-4">Edite <strong>'+a.seccion+"</strong></h3>",t+='<div class="mb-4 d-flex justify-content-between">',t+='<div class="d-flex flex-column" style="width:70%">',t+='<label  class="form-label"><strong>Nombre:</strong></label>',t+='<input type="text" class="form-control" id="seccion'+a.id+'" value="'+a.seccion+'">',t+="</div>",t+='<div class="d-flex flex-column" style="width:28%">',t+='<label class="form-label"><strong>Color:</strong></label>',t+='<input type="color" class="form-control  puntero" id="color'+a.id+'" value="'+a.color+'">',t+="</div>",t+="</div>",t+='<div class="mb-4">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Descripción:</strong></label>',""==a.descripcion?t+='<textarea class="form-control" rows="6" id="descripcion'+a.id+'" placeholder="Esta Sección no tiene descripción"></textarea>':t+='<textarea class="form-control" rows="6" id="descripcion'+a.id+'" >'+a.descripcion+"</textarea>",t+="</div>",t+='<div class="mb-4">',t+='<div class="w-100">',t+='<label class="form-label"><strong>Mover Carpeta:</strong></label>',t+="</div>",t+='<div style="height:30px">',t+='<select style="width:100%;height:100% !important" id="select'+a.id+'" class="js-example-basic-single" >';const i={id:"0",idPadre:"0",seccion:"CARPETA BASE",descripcion:"",color:"#000000",path:"/base"};let o=JSON.parse(a.carpetas);o.unshift(i),o.forEach(e=>{e.id!=a.id&&(t+='<optgroup label="'+e.seccion+'">',t+='<option value="'+e.id+'" '+(e.id==a.idPadre?"selected":"")+'><strong><i class="fa-solid fa-folder-open"></i></strong>'+e.path+"</option>",t+="</optgroup>")}),t+="</select>",t+="</div>",t+='<div class="w-100 mt-4" id="alertas'+a.id+'">',t+="</div>",t+="</div>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+e+","+a.id+',2)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>"}document.getElementById("dibujar-js").innerHTML=t,document.getElementById("dibujar-tabla").innerHTML="",waitResponse("#contenedorCarpetas"),e>0&&await dibujarDocs(e),$("#select"+e).select2({dropdownParent:$("#exampleModalEditar"+e)})}async function dibujarHijosPadre(e,t=[]){let a="";a=t.length>0?t:await traerHijos(e);var i="";0===a.length?(i+='<div class="alert  px-5 py-2 mt-3 w-100 ">',i+='<div class="d-flex justify-content-center align-items-center">',i+='<h4 class="" style="color:red">No Existen Carpetas</h4>',i+="</div>",i+="</div>"):(i+='<div class="d-flex justify-content-center " style="flex-wrap:wrap">',a.forEach(t=>{i+='<div class="p-3 padreCarpeta">',i+='<a class="btn hoverCarpeta" style="border:1px solid #e2e4e6" onclick="dibujarPadreAndCarpetas('+t.id+')">',i+='<div class="row justify-content-center align-items-center  widthCarpeta ">',i+='<div class="">',i+='<i class="fa-regular fa-folder-open" style="font-size:40px;margin-bottom:10px;color:'+t.color+'"></i>',i+='<div style="margin-bottom:-7px">',i+='<p style="font-weight:bold">'+(t.seccion[0].toUpperCase()+t.seccion.substring(1))+"</p>",i+="</div>",i+="</div>",i+="</div>",i+="</a>",i+='<div class="d-flex justify-content-center align-items-center elip">',i+='<buttom class="btn btn-outline-secondary botonesCarpeta btn-hover dropdown-toggle py-2 px-3"  style="border:none" data-bs-toggle="dropdown" aria-expanded="false" type="buttom">',i+='<i class="fa-solid fa-ellipsis-vertical fa-xl elip" ></i>',i+="</buttom>",i+='<ul class="dropdown-menu dropdown-menu-dark">',i+='<li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModal'+t.id+'"><i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>Editar</a></li>',i+='<li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+t.id+')"><i class="fa-solid fa-trash" style="margin-right:7px"></i>Eliminar</a></li>',i+=" </ul>",i+="</div>",i+="</div>",i+='<div class="modal fade" id="exampleModal'+t.id+'" tabindex="-1" aria-labelledby="exampleModalLabel'+t.id+'" aria-hidden="true">',i+='<div class="modal-dialog">',i+='<div class="modal-content">',i+='  <div class="modal-header bg-black">',i+='   <h5 class="modal-title text-white">Editar</h5>',i+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',i+="  </div>",i+='  <div class="modal-body" style="min-height:350px">',i+='<h3 class="text-black mt-2 mb-4">Edite <strong>'+t.seccion+"</strong></h3>",i+='<div class="mb-4 d-flex justify-content-between">',i+='<div class="d-flex flex-column" style="width:70%">',i+='<label  class="form-label"><strong>Nombre:</strong></label>',i+='<input type="text" class="form-control" id="seccion'+t.id+'" value="'+t.seccion+'">',i+="</div>",i+='<div class="d-flex flex-column" style="width:28%">',i+='<label class="form-label"><strong>Color:</strong></label>',i+='<input type="color" class="form-control  puntero" id="color'+t.id+'" value="'+t.color+'">',i+="</div>",i+="</div>",i+='<div class="mb-4">',i+='<label for="exampleFormControlInput1" class="form-label"><strong>Descripción:</strong></label>',""==t.descripcion?i+='<textarea class="form-control" rows="6" id="descripcion'+t.id+'" placeholder="Esta Sección no tiene descripción"></textarea>':i+='<textarea class="form-control" rows="6" id="descripcion'+t.id+'" >'+t.descripcion+"</textarea>",i+="</div>",i+='<div class="mb-4">',i+='<div class="w-100">',i+='<label class="form-label"><strong>Mover Carpeta:</strong></label>',i+="</div>",i+='<div style="height:30px">',i+='<select style="width:100%;height:100% !important" id="select'+t.id+'" class="js-example-basic-single" >';let a=JSON.parse(t.carpetas);console.log("carpetas para mover",a),a.unshift({id:"0",idPadre:"0",seccion:"CARPETA BASE",descripcion:"",color:"#000000",path:"/base"}),a.forEach(a=>{a.id!=t.id&&(i+='<optgroup label="'+a.seccion+'">',i+='<option value="'+a.id+'" '+(a.id==e?"selected":"")+'><strong><i class="fa-solid fa-folder-open"></i></strong>'+a.path+"</option>",i+="</optgroup>")}),i+="</select>",i+="</div>",i+='<div class="w-100 mt-4" id="alertas'+t.id+'">',i+="</div>",i+="</div>",i+="</div>",i+='<div class="modal-footer">',i+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',i+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+e+","+t.id+',2)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',i+="</div>",i+="</div>",i+="</div>",i+="</div>"}),i+="</div>"),document.getElementById("contenedorCarpetas").innerHTML=i,a.forEach(e=>{$("#select"+e.id).select2({dropdownParent:$("#exampleModal"+e.id)})})}async function dibujarDocs(e,t=[]){let a,i=(await traerSecciones()).find(t=>t.id==e);a=0==t.length?await traerDocs(e):t;var o="";o+='<div class="accordion" id="accordionExample">',o+='<div class="accordion-item ">',o+='<h2 class="accordion-header" id="headingOne">',o+='<button class="accordion-button '+(a.length>0?"":"collapsed")+' contenedor-carpetas" type="button"  style="height:55px" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"><div class="d-flex w-100 justify-content-center"><h4 style="color:black">Documentos de<strong> '+i.seccion+"</strong></h4></div></button>",o+=" </h2>",o+='<div id="collapseOne" class="accordion-collapse collapse '+(a.length>0?"show":"")+'" data-bs-parent="#accordionExample">',o+=' <div class="accordion-body px-0">',o+='<div class="d-flex mb-3 justify-content-end ">',o+='<a title="Ver todos los Documentos" class="btn btn-primary" style="margin-right:3px" id="mostrarDocs"  onclick="mostrarDocsPro('+e+')"><i class="fa-regular fa-eye fa-2x"></i></a>',o+='<a class="btn btn-warning"  onclick="agregarDocumento('+e+')"><i class="fa-solid fa-plus fa-2x"></i><span class="span-boton">Documento</span></a>',o+="</div>",o+='<table class="table" style="min-width:1000px" id="tablaDocsUltimo">',o+='<thead class="table-dark">',o+='<tr class="" style="text-transform:uppercase">',o+="<th>N°</th>",o+='<th class="">Nombre</th>',o+='<th class="">Carpeta</th>',o+='<th class="">Form</th>',o+='<th class="">Datos</th>',o+='<th class="">Responsable</th>',o+='<th class="">Fecha</th>',o+='<th class="">Acciones</th>',o+="</tr>",o+="</thead>",o+='<tbody class="contenido" id="contenido">',a.length>0&&a.forEach((e,t)=>{console.log("documento",e),o+="<tr>",o+="<td>"+(parseInt(t)+1)+"</td>",""==e.alias?o+="<td>"+e.codigo+"</td>":o+="<td>"+e.alias+"</td>",o+="<td>"+e.seccion+"</td>",o+="<td>"+e.formulario+"</td>",o+='<td><buttom class="btn btn-secondary" style="margin-left:12px" data-bs-toggle="modal" data-bs-target="#exampleModalVer'+e.id+'">Ver</buttom></td>',o+="<td>"+e.responsable+"</td>",o+='<td class="col-2"><div class="row"><p>'+e.created_at.split(" ")[0]+"</p><p>"+e.created_at.split(" ")[1]+"</p></div></td>",o+='<td class="col-2">';const a="'"+e.path+"'",i="'"+e.codigo+"'";o+='<buttom title="Ver Documento" class="btn btn-outline-primary" style="margin-right:5px;height:30px;width:32px" onclick="abrirPdf('+a+","+i+')"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',o+='<buttom title="Descargar Documento" class="btn btn-primary" style="margin-right:5px;height:30px;width:32px"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',o+='<buttom title="Editar" class="btn btn-warning"  data-bs-toggle="modal" data-bs-target="#exampleModalEditar'+e.id+'" style="margin-right:5px;height:30px;width:32px"><i class="fa-solid fa-pen-to-square fa-2x"></i></i></buttom>',o+='<buttom title="Eliminar" class="btn btn-outline-danger" style=";height:30px;width:32px" onclick="deleteDoc('+e.id+')"><i class="fa-solid fa-trash fa-2x"></i></buttom>',o+="</td>",o+="</tr>",o+='<div class="modal fade" id="exampleModalVer'+e.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',o+=' <div class="modal-dialog modal-dialog-centered">',o+=' <div class="modal-content">',o+=' <div class="modal-header bg-black ">',o+=' <h5 class="modal-title text-white" id="exampleModalLabel">Metadatos del Documento <strong>'+e.codigo+"</strong></h5>",o+='<button type="button" class="btn text-white" style="font-size:13px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',o+=" </div>",o+='  <div class="modal-body">';let s=JSON.parse(e.data);o+="<p><strong>KEYWORDS</strong></p>",o+="<p>"+e.keywords+"</p>",s.forEach(e=>{o+="<p><strong>"+e.nombre.toUpperCase()+"</strong></p>",o+="<p>"+e.valor+"</p>"}),o+="  </div>",o+=' <div class="modal-footer">',o+=' <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',o+="  </div>",o+="</div>",o+="</div>",o+="</div>",o+='<div class="modal fade" id="exampleModalEditar'+e.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',o+=' <div class="modal-dialog modal-dialog-centered">',o+=' <div class="modal-content">',o+=' <div class="modal-header bg-black ">',o+=' <h5 class="modal-title text-white" id="exampleModalLabel">Editar Metadados <strong>'+e.codigo+"</strong></h5>",o+='<button type="button" class="btn text-white" style="font-size:13px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',o+=" </div>",o+='  <div class="modal-body">';let n=JSON.parse(e.data);o+='<div class="mb-4" id="keywords">',o+='<label class="form-label"><strong>KEYWORDS</strong></label>',o+='<input class="form-control edit-campos'+e.id+'" name="keywords"  value="'+e.keywords+'">',o+="</div>",n.forEach(t=>{o+='<div class="mb-4" id="'+t.nombre.trim()+'">',o+='<label class="form-label"><strong>'+t.nombre.toUpperCase()+"</strong></label>",o+='<input class="form-control edit-campos'+e.id+'" name="'+t.nombre.trim()+'"  value="'+t.valor+'">',o+="</div>"}),o+="  </div>",o+=' <div class="modal-footer mt-3">',o+=' <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',o+=' <button type="button" class="btn btn-success" onclick="saveEditDoc('+e.id+')"><i class="fa-solid fa-floppy-disk" style="margin-right:3px"></i>Guardar</button>',o+="  </div>",o+="</div>",o+="</div>",o+="</div>"}),o+="</tbody>",o+="</table>",o+="</tbody>",o+=" </div>",o+=" </div>",o+="</div>",o+="</div>",document.getElementById("dibujar-tabla").innerHTML=o,0!==t.length&&document.getElementById("mostrarDocs").classList.add("disabledButtom"),$("#tablaDocsUltimo").DataTable()}async function waitResponse(e,t="129.5px",a=1){var i="";1==a?(i+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+t+'">',i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+="</div>"):(i+='<td colspan="8" valign="top">',i+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+t+'">',i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+=' <div class="spinner-grow" role="status">',i+='<span class="visually-hidden">Loading...</span>',i+="</div>",i+="</div>",i+="</td>"),document.querySelector(e).innerHTML=i}async function saveEditDoc(e){const t=document.querySelectorAll(".edit-campos"+e),a=Array.apply(null,t),i=[];let o;if(a.forEach(e=>{let t=e.name,a=e.value;if(""==e.value){e.classList.add("errorInput");const a=document.createElement("div");a.id="divAlerta"+t,a.textContent="El campo "+t+" es OBLIGATORIO",a.style.color="red";let i=document.getElementById(t);document.getElementById("divAlerta"+t)||i.appendChild(a)}else{e.classList.remove("errorInput");const s=document.getElementById("divAlerta"+t);s&&(s.innerHTML=""),"keywords"==t?o=a:i.push({nombre:t,valor:a})}}),a.length==i.length+1){const t=new FormData;t.append("id",e),t.append("keywords",o),t.append("data",JSON.stringify(i)),console.log([...t]);let a=URL_BASE+"/documento/update";const s=await fetch(a,{method:"POST",headers:{token:token},body:t}),n=await s.json();console.log(n),n.exito?Swal.fire({position:"top-end",icon:"success",title:n.exito,showConfirmButton:!1,timer:1500}).then(()=>{$("#exampleModalEditar"+e).modal("hide"),dibujarPadreAndCarpetas(n.padre)}):n.error?Swal.fire({icon:"error",title:"ERROR",text:n.error}):n.archivo?Swal.fire({icon:"error",title:"ERROR",text:n.archivo}):n.exit?Swal.fire({icon:"warning",title:n.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(html+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',n.alertas.error.forEach(e=>{html+='<li class="text-danger"  >',html+=e,html+="</li>"}),html+="</ul>",document.getElementById("alertas").innerHTML=html),alertas()}}async function mostrarDocsPro(e){$.ajax({data:{tipo:"allDocs",id:e},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),waitResponse(".odd","50px",2),setTimeout(()=>{if(0==t.length){'<td colspan="8" valign="top">','<div class="alert  px-5 py-2 mt-3 w-100 ">','<div class="d-flex justify-content-center align-items-center">','<h4 class="" style="color:red">No Existen Documentos</h4>',"</div>","</div>","</td>",document.querySelector(".odd").innerHTML='<td colspan="8" valign="top"><div class="alert  px-5 py-2 mt-3 w-100 "><div class="d-flex justify-content-center align-items-center"><h4 class="" style="color:red">No Existen Documentos</h4></div></div></td>'}else dibujarDocs(e,t)},500)}).fail(e=>{console.log(e)})}async function agregarDocumento(e){let t=await traerSecciones(),a=await traerFormularios();console.log("formularios",a);let i=t.find(t=>t.id==e);var o="";document.getElementById("dibujar-tabla").innerHTML="",o+='<h1 class="text-black mb-3"><strong>Agregar Documentos en '+i.seccion+"</strong></h1>",o+='<div class="mb-3">',o+='<div class="d-flex justify-content-start">',o+='<a class=" btn btn-outline-danger " onclick="dibujarPadreAndCarpetas('+e+')"><i class="fa-solid fa-arrow-left fa-2x"></i> <span class="span-boton">Regresar</span></a>',o+="</div>",o+="</div>",o+='<div class="contenedor-crearUsuario bg-light contenedor-carpetas px-3">',o+='<h3 class="text-black mt-2 mb-4">Elija un Formulario para agregar el documento</h3>',o+='<div class="mb-3">',o+='<label for="exampleFormControlInput1" class="form-label"><strong>Formulario:</strong></label>',o+='<select class="form-select w-100" style="height:30px" id="seccion" onchange="elegirSeccionAgregar(this.value,'+e+')">',o+=' <option value="" selected disabled> -- Seleccione un formulario -- </option>',a.forEach(e=>{o+=' <option value="'+e.id+'">'+e.nombre+"</option>"}),o+="</select>",o+="</div>",o+="</div>",o+="</div>",document.getElementById("dibujar-js").innerHTML=o}async function elegirSeccionAgregar(e,t){console.log("id",e);var a="";let i=await traerFormulario(e);console.log("formulario escogido"),a+='<div class="contenedor-crearUsuario bg-light px-3">',a+='<h3 class="text-black mt-2 mb-4">Ingrese los datos del documento</h3>';let o=JSON.parse(i.campos),s=JSON.parse(i.keywords),n=JSON.parse(i.archivo).map(e=>"."+e);a+='<div class="row">',a+='<div class="mb-3 w-100" id="'+s.input+'" >',a+='<label class="form-label"><strong>Ingrese '+s.input+":</strong></label>",a+='<input type="'+s.type+'" class="form-control datos"  name="'+s.input+'" value="" placeholder="Agregue palabras clave del documento">',a+="</div>",o.forEach(e=>{const{input:t,type:i}=e;a+='<div class="mb-3 w-100" id="'+t+'">',a+='<label class="form-label"><strong>Ingrese '+t[0].toUpperCase()+t.substring(1)+":</strong></label>",a+="text"==i?'<textarea class="w-100 form-control datos" name="'+t+'" rows="5"></textarea>':' <input type="'+i+'" class="form-control datos"  name="'+t+'">',a+="</div>"}),a+="</div>",a+='<div class="mb-3 w-100" id="archivo">',a+='<label class="form-label"><strong>Cargar el archivo:</strong></label>',a+=' <input type="file" class="form-control datos" name="archivo" accept="'+n+'">',a+="</div>",a+='<div class="w-100 mt-2" id="alertas">',a+="</div>",a+='<div class="my-5 d-flex justify-content-center align-items-center">',a+='<a class="btn btn-success px-5 py-2" id="botonCrear" style="font-size:15px" onclick="saveArchivo('+i.id+","+t+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',a+="</div>",document.getElementById("dibujar-tabla").innerHTML=a}async function saveArchivo(e,t){var a="";const i=document.querySelectorAll(".datos"),o=Array.apply(null,i),s=[];let n,l;if(o.forEach(e=>{let t=e.name,a=e.value;if(""==e.value){e.classList.add("errorInput");const a=document.createElement("div");a.id="divAlerta"+t,a.textContent="El campo "+t+" es OBLIGATORIO",a.style.color="red";let i=document.getElementById(t);document.getElementById("divAlerta"+t)||i.appendChild(a)}else{e.classList.remove("errorInput");const i=document.getElementById("divAlerta"+t);i&&(i.innerHTML=""),"keywords"==t?n=a:"archivo"==t?l=e.files[0]:s.push({nombre:t,valor:a})}}),s.length==o.length-2){const i=new FormData;i.append("idSeccion",t),i.append("idFormulario",e),i.append("keywords",n),i.append("path",l),i.append("data",JSON.stringify(s)),console.log([...i]);let o=URL_BASE+"/documento/create";const r=await fetch(o,{method:"POST",headers:{token:token},body:i}),d=await r.json();console.log(d),d.exito?Swal.fire({position:"top-end",icon:"success",title:d.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarPadreAndCarpetas(t)}):d.error?Swal.fire({icon:"error",title:"ERROR",text:d.error}):d.archivo?Swal.fire({icon:"error",title:"ERROR",text:d.archivo}):d.exit?Swal.fire({icon:"warning",title:d.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(a+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',d.alertas.error.forEach(e=>{a+='<li class="text-danger"  >',a+=e,a+="</li>"}),a+="</ul>",document.getElementById("alertas").innerHTML=a),alertas()}}async function deleteDoc(e){let t,a=await traerDocumento(e);t=""==a.alias?a.codigo:a.alias,console.log("documento a eliminar",a),Swal.fire({title:"ELIMINAR",html:" Estas seguro de Eliminar de forma permamente el documento <strong>"+t+"</strong> ?",icon:"error",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(t=>{t.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/documento/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{console.log("response Eliminar",e),e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarPadreAndCarpetas(e.padre)}):e.error?Swal.fire({icon:"error",title:"ERROR",html:"<strong>"+e.carpeta+"</strong> "+e.error}).then(()=>{dibujarPadreAndCarpetas(e.padre)}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}function botonesGuardar(e,t="px-2",a="py-3"){document.getElementById(e).innerHTML="";let i="";i+='<buttom type="buttom" class="btn d-flex '+t+" "+a+' cursito justify-content-center align-items-center" style="background-color:#198754" disabled>',i+='<span class="spinner-border spinner-border-sm" style="width: 1.8rem; height: 1.8rem;color:white" role="status" aria-hidden="true"></span>',i+='<span style="margin-left:15px;font-size:14px;color:white">Cargando...</span>',i+="</button>",document.getElementById(e).innerHTML=i}async function createSeccion(e=0){var t="";const a=document.getElementById("seccion").value,i=document.getElementById("descripcion").value,o=document.getElementById("color").value;hexToRgb(o);const s=new FormData;s.append("idPadre",e),s.append("seccion",a),s.append("descripcion",i),s.append("color",o),console.log([...s]);const n=await fetch("http://localhost/gdagmcp/carpeta/create",{method:"POST",headers:{token:token},body:s}),l=await n.json();l.exito?Swal.fire({position:"top-end",icon:"success",title:l.exito,showConfirmButton:!1,timer:1500}).then(()=>{$("#exampleModal"+e).modal("hide"),dibujarPadreAndCarpetas(e)}):l.error?Swal.fire({icon:"error",title:"ERROR",text:l.error}).then(()=>{$("#exampleModal"+e).modal("hide"),dibujarPadreAndCarpetas(e)}):l.exit?Swal.fire({icon:"warning",title:l.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(t+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',l.alertas.error.forEach(e=>{t+='<li class="text-danger"  >',t+=e,t+="</li>"}),t+="</ul>",document.getElementById("alertas").innerHTML=t),alertas()}async function updateSeccion(e,t,a){var i="";const o=document.getElementById("seccion"+t).value,s=document.getElementById("descripcion"+t).value,n=document.getElementById("color"+t).value,l=document.getElementById("select"+t).value,r=new FormData;r.append("hijo",t),r.append("padre",e),r.append("seccion",o),r.append("descripcion",s),r.append("color",n),e!=l&&r.append("idPadre",l),1==a?r.append("tipo","updatePadre"):r.append("tipo","updateHijo"),console.log([...r]);const d=await fetch("http://localhost/gdagmcp/carpeta/update",{method:"POST",headers:{token:token},body:r}),c=await d.json();c.exito?Swal.fire({position:"top-end",icon:"success",title:c.exito,showConfirmButton:!1,timer:1500}).then(()=>{$("#exampleModal"+t).modal("hide"),$("#exampleModalEditar"+t).modal("hide"),dibujarPadreAndCarpetas(e)}):c.error?Swal.fire({icon:"error",title:"ERROR",text:c.error}).then(()=>{$("#exampleModal"+t).modal("hide"),$("#exampleModalEditar"+t).modal("hide"),dibujarPadreAndCarpetas(e)}):c.exit?Swal.fire({icon:"warning",title:c.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(console.log("alertas",c),i+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',c.alertas.error.forEach(e=>{i+='<li class="text-danger"  >',i+=e,i+="</li>"}),i+="</ul>",document.getElementById("alertas"+t).innerHTML=i),alertas()}async function deleteSeccion(e){const t=(await traerSecciones()).find(t=>t.id==e);Swal.fire({title:"ELIMINAR",text:`Estas seguro de Eliminar de forma permamente a ${t.seccion}?`,icon:"error",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(a=>{a.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/carpeta/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{console.log("response Eliminar",e),e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarPadreAndCarpetas(t.idPadre)}):e.error?Swal.fire({icon:"error",title:"ERROR",html:"<strong>"+e.carpeta+"</strong> "+e.error}).then(()=>{dibujarPadreAndCarpetas(t.idPadre)}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}function abrirPdf(e,t){window.open(URL_BASE+"/public/archivos"+e,t,"width=620,height=400,fullscreen=yes,scrollbars=NO"),parent.opener=top,opener.close()}document.addEventListener("DOMContentLoaded",iniciarApp()),escucharCarpeta=(e,t)=>{$.ajax({data:{tipo:"buscarCarpetas",value:e,id:t},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),console.log(e),dibujarHijosPadre(t,e)}).fail(e=>{console.log(e)})};