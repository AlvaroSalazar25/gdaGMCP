const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles,permisosDefault=[{id:"1",nombre:"Leer",status:"false"},{id:"2",nombre:"Escribir",status:"false"}];async function iniciarApp(){secciones=await traerHijos(0),console.log("secciones",secciones),dibujarHijos(0,secciones)}function alertas(){const e=document.querySelectorAll(".alert"),a=document.getElementById("alertas"),t=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),a&&(a.innerHTML=""),t&&(t.innerHTML="")}))},3e3)}function traerSecciones(){return new Promise((e,a)=>{let t=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(a=>{a.exit&&Swal.fire({icon:"warning",title:a.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==a.length&&e(t),$.each(a,(i,o)=>{t.push(o),a.length==i+1&&e(t)})}).fail(e=>{a(e)})})}function traerFormularios(){return new Promise((e,a)=>{let t=[];$.ajax({data:{tipo:"formularios"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(a=>{a.exit&&Swal.fire({icon:"warning",title:a.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==a.length&&e(t),$.each(a,(i,o)=>{t.push(o),a.length==i+1&&e(t)})}).fail(e=>{a(e)})})}function traerHijos(e=0){return new Promise((a,t)=>{let i=[];$.ajax({data:{id:e,tipo:"hijos"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&a(i),$.each(e,(t,o)=>{i.push(o),e.length==t+1&&a(i)})}).fail(e=>{t(e)})})}async function dibujarSecciones(){var e="";let a=await traerSecciones();e+='<h1 class="text-black mb-3"><strong>Administrar Secciones</strong></h1>',e+="<section>",e+='<div class="mb-3">',e+='<div class="d-flex justify-content-end">',e+='<a class=" btn btn-primary " onclick="agregarSeccion(0)"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Sección</span></a>',e+="</div>",e+="</div>",e+="</section>",console.log(a),e+='<div class="mt-4 d-flex" style="flex-wrap:wrap">',a.forEach(a=>{0==a.idPadre&&(e+='<div class="p-3 ">',e+='<a class="btn btn-outline-dark" style="border:1px solid" onclick="entrarSeccion('+a.id+')">',e+='<div class="row justify-content-center align-items-center hoverCarpeta widthCarpeta">',e+="<div>",e+='<i class="fa-regular fa-folder-open" style="font-size:40px"></i>',e+='<p class="botonCarpeta">'+a.seccion+"</p>",e+="</div>",e+="</div>",e+="</a>",e+="</div>")}),e+="</div>",document.getElementById("dibujar-js").innerHTML=e}async function dibujarAtras(e){let a=await traerSecciones(),t=a.find(a=>a.id==e),i=a.filter(e=>e.idPadre==t.idPadre);dibujarHijos(t.idPadre,i)}async function dibujarHijos(e,a){console.log("padre",e),console.log("hijo",a);var t="";let i=await traerSecciones(),o=await traerFormularios(),s=i.find(a=>a.id==e);console.log("seccionActual",s),null==s?(t+='<h1 class="text-black mb-3"><strong>Administrar Secciones</strong></h1>',t+='<div class="mt-5 mb-3 d-flex justify-content-between">',t+='<div class="d-flex justify-content-end">',t+='<a class=" btn btn-outline-danger noVisible" onclick="dibujarAtras('+e+')"><i class="fa-solid fa-arrow-left-long fa-2x"></i> <span class="span-boton">Atrás</span></a>',t+="</div>"):(t+='<div class="d-flex justify-content-center">',t+='<h1 class="text-black mb-3"><strong>Sección '+s.seccion+"</strong></h1>",t+='<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" style="margin-left:5px;width:30px;height:30px;border-radius:15px">',t+='<i class="fa-solid fa-ellipsis-vertical fa-xl "></i>',t+="</button>",t+='<ul class="dropdown-menu dropdown-menu-dark">',t+=' <li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModalEditar'+s.id+'">',t+='<i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>',t+="Editar</a></li>",t+=' <li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+s.id+')">',t+='<i class="fa-solid fa-trash" style="margin-right:7px"></i>',t+="Eliminar</a></li>",t+=" </ul>",t+="</div>",t+='<h3 class="text-black mb-3">'+s.descripcion+"</h3>",t+='<div class="mt-5 mb-3 d-flex justify-content-between">',t+='<div class="d-flex justify-content-end">',t+='<a class=" btn btn-outline-danger" onclick="dibujarAtras('+e+')"><i class="fa-solid fa-arrow-left-long fa-2x"></i> <span class="span-boton">Atrás</span></a>',t+="</div>"),t+='<div class="d-flex justify-content-end">',t+='<a class=" btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal'+e+'" id="'+e+'"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Sección</span></a>',t+="</div>",t+="</div>",t+='<section class="contenedor-crearUsuario bg-light my-4">',null!=s&&"1"!=s.idFormulario&&(t+='<p style="font-size:12px"><strong>Formulario: </strong>'+(s.nombreFormulario[0].toUpperCase()+s.nombreFormulario.substring(1))+"</p>"),t+='<div class=" d-flex justify-content-center" style="flex-wrap:wrap">',0==a.length?(t+='<div class="alert bg-danger px-5 py-2 mt-3 w-100" style="border-radius:5px;border:1px solid red">',t+='<div class="d-flex justify-content-center align-items-center">',t+='<h4 class="text-white">No Existen Archivos</h4>',t+="</div>",t+="</div>"):a.forEach(a=>{t+='<div class="p-3 padreCarpeta ">',t+='<div class="botonesCarpeta row justify-content-center align-items-center">',t+='<button type="button" style="border:none" class="btn btn-outline-secondary dropdown-toggle py-2 px-3" data-bs-toggle="dropdown" aria-expanded="false">',t+='<i class="fa-solid fa-ellipsis-vertical fa-xl "></i>',t+="</button>",t+='<ul class="dropdown-menu dropdown-menu-dark">',t+=' <li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModal'+a.id+'">',t+='<i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>',t+="Editar</a></li>",t+=' <li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+a.id+')">',t+='<i class="fa-solid fa-trash" style="margin-right:7px"></i>',t+="Eliminar</a></li>",t+=" </ul>",t+="</div>",t+='<a class="btn btn-outline-dark " style="border:1px solid" onclick="entrarSeccion('+a.id+')">',t+='<div class="row justify-content-center align-items-center hoverCarpeta widthCarpeta">',t+="<div>",t+='<i class="fa-regular fa-folder-open" style="font-size:40px"></i>',t+='<p class="botonCarpeta">'+(a.seccion[0].toUpperCase()+a.seccion.substring(1))+"</p>",t+="</div>",t+="</div>",t+="</a>",t+="</div>",t+='<div class="modal fade" id="exampleModal'+a.id+'" tabindex="-1" aria-labelledby="exampleModalLabel'+a.id+'" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+='   <h5 class="modal-title text-white">Editar Sección</h5>',t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body">',t+='<h3 class="text-black mt-2 mb-4">Edite la sección '+a.seccion+"</h3>",t+="<form >",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Nombre de la Seccion:</strong></label>',t+='<input type="text" class="form-control" id="seccion'+a.id+'" value="'+a.seccion+'">',t+="</div>",t+='<div class="mb-3">',t+='<label class="form-label"><strong>Formulario de la Seccion:</strong></label>',t+='<select class="form-select" id="formulario'+a.id+'" style="height:30px">',t+='<option value="" selected disabled> -- Seleccione una opcion -- </option>',o.forEach(e=>{a.idFormulario==e.id?t+='<option value="'+e.id+'" selected>'+e.nombre+"</option>":t+='<option value="'+e.id+'">'+e.nombre+"</option>"}),t+="</select>",t+="</div>",t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Descripcion de la Seccion:</strong></label>',""==a.descripcion?t+='<textarea class="form-control" rows="5" id="descripcion'+a.id+'" placeholder="Esta Sección no tiene descripción"></textarea>':t+='<textarea class="form-control" rows="5" id="descripcion'+a.id+'" >'+a.descripcion+"</textarea>",t+="</div>",t+='<div class="w-100 mt-2" id="alertas">',t+="</div>",t+="</form>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+e+","+a.id+',2)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>"}),t+="</div>",t+="</section>",t+='<div class="modal fade" id="exampleModal'+e+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+=null==s?'   <h5 class="modal-title text-white">Agregar Sección</h5>':'   <h5 class="modal-title text-white">Agregar Sección en '+s.seccion+"</h5>",t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body">',t+='<h3 class="text-black mt-2 mb-4">Ingrese los datos de la nueva Sección</h3>',t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Nombre de la Seccion:</strong></label>',t+='<input type="text" class="form-control" id="seccion" name="seccion" placeholder="Ingrese nombre">',t+="</div>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Formulario de la Seccion:</strong></label>',t+='<select class="form-select" id="formulario" name="formulario" style="height:30px">',t+='<option value="" selected disabled> -- Seleccione una opcion -- </option>',o.forEach(e=>{t+='<option value="'+e.id+'">'+e.nombre+"</option>"}),t+="</select>",t+="</div>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Descripcion de la Seccion:</strong></label>',t+='<textarea class="form-control" rows="5" id="descripcion" placeholder="Ingrese descripción"></textarea>',t+="</div>",t+='<div class="w-100 mt-2" id="alertas">',t+="</div>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+=null==s?'<a class="btn btn-success" id="botonCrear" onclick="createSeccion(0,)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>':'<a class="btn btn-success" id="botonCrear" onclick="createSeccion('+e+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>",void 0!==s&&(t+='<div class="modal fade" id="exampleModalEditar'+e+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+='   <h5 class="modal-title text-white">Editar Sección</h5>',t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body">',t+='<h3 class="text-black mt-2 mb-4">Editar datos de la Sección '+s.seccion+"</h3>",t+="<form>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Nombre de la Seccion:</strong></label>',t+='<input type="text" class="form-control" id="seccion'+s.id+'" placeholder="Ingrese nombre" value="'+s.seccion+'">',t+="</div>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Formulario de la Seccion:</strong></label>',t+='<select class="form-select" id="formulario'+s.id+'" style="height:30px">',t+='<option value="" selected disabled> -- Seleccione una opcion -- </option>',o.forEach(e=>{e.id==s.idFormulario?t+='<option value="'+e.id+'" selected>'+e.nombre+"</option>":t+='<option value="'+e.id+'">'+e.nombre+"</option>"}),t+="</select>",t+="</div>",t+='<div class="mb-3">',t+='<label  class="form-label"><strong>Descripcion de la Seccion:</strong></label>',""!=s.descripcion?t+='<textarea class="form-control" rows="5" id="descripcion'+s.id+'" >'+s.descripcion+"</textarea>":t+='<textarea class="form-control" rows="5" id="descripcion'+s.id+'" placeholder="Esta Seccion no tiene descripcion" ></textarea>',t+="</div>",t+='<div class="w-100 mt-2" id="alertas">',t+="</div>",t+="</form>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+s.id+","+s.id+',1)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>"),document.getElementById("dibujar-js").innerHTML=t}async function entrarSeccion(e){dibujarHijos(e,await traerHijos(e))}async function guardarFormulario(e){let a=document.getElementById("formularioSelected"+e).value;var t="";if(""==a)document.getElementById("alertas"+e).classList.remove("apagar"),document.getElementById("btnSaveForm"+e).classList.add("apagar"),document.getElementById("formularioSelected"+e).classList.add("errorInput"),t+='<div class="d-flex justify-content-center align-items-center bg-danger mt-1 py-2 mx-3 text-white" style="font-size:14px;border:1px solid red;border-radius:5px">Debe seleccionar un Formulario</div>',document.getElementById("alertas"+e).innerHTML=t,setTimeout(()=>{document.getElementById("btnSaveForm"+e).classList.remove("apagar"),document.getElementById("formularioSelected"+e).classList.remove("errorInput"),document.getElementById("alertas"+e).classList.add("apagar")},2e3);else{botonesGuardar("btnSaveForm"+e,"px-0","py-0"),$("#exampleModalAddFormulario"+e).modal("hide");const a=new FormData,i=document.getElementById("formularioSelected"+e).value;a.append("idFormulario",i),a.append("idSeccion",e),console.log([...a]);let o=URL_BASE+"/seccion/formulario/agregar";const s=await fetch(o,{method:"POST",headers:{token:token},body:a}),n=await s.json();console.log(n),n.exito?Swal.fire({position:"top-end",icon:"success",title:n.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):n.error?Swal.fire({icon:"error",title:"ERROR",text:n.error}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):n.exit?Swal.fire({icon:"warning",title:n.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(t+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',n.alertas.error.forEach(e=>{t+='<li class="text-danger"  >',t+=e,t+="</li>"}),t+="</ul>",document.getElementById("alertas").innerHTML=t),alertas()}}function botonesGuardar(e,a="px-2",t="py-3"){document.getElementById(e).innerHTML="";let i="";i+='<buttom type="buttom" class="btn d-flex '+a+" "+t+' cursito justify-content-center align-items-center" style="background-color:#198754" disabled>',i+='<span class="spinner-border spinner-border-sm" style="width: 1.8rem; height: 1.8rem;color:white" role="status" aria-hidden="true"></span>',i+='<span style="margin-left:15px;font-size:14px;color:white">Cargando...</span>',i+="</button>",document.getElementById(e).innerHTML=i}async function createSeccion(e=0){var a="";const t=await traerHijos(e),i=document.getElementById("seccion").value,o=document.getElementById("descripcion").value,s=document.getElementById("formulario").value;console.log("formulario",s);const n=new FormData;n.append("idPadre",e),""==s?n.append("idFormulario",1):n.append("idFormulario",s),n.append("seccion",i),n.append("descripcion",o),console.log([...n]);const l=await fetch("http://localhost/gdagmcp/seccion/create",{method:"POST",headers:{token:token},body:n}),r=await l.json();r.exito?Swal.fire({position:"top-end",icon:"success",title:r.exito,showConfirmButton:!1,timer:1500}).then(()=>{$("#exampleModal"+e).modal("hide"),dibujarHijos(e,r.hijos)}):r.error?Swal.fire({icon:"error",title:"ERROR",text:r.error}).then(()=>{$("#exampleModal"+e).modal("hide"),dibujarHijos(e,t)}):r.exit?Swal.fire({icon:"warning",title:r.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(a+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',r.alertas.error.forEach(e=>{a+='<li class="text-danger"  >',a+=e,a+="</li>"}),a+="</ul>",document.getElementById("alertas").innerHTML=a),alertas()}async function updateSeccion(e,a,t){var i="";const o=document.getElementById("seccion"+a).value,s=document.getElementById("descripcion"+a).value,n=document.getElementById("formulario"+a).value,l=new FormData;l.append("hijo",a),l.append("padre",e),""!=n&&l.append("idFormulario",n),l.append("seccion",o),l.append("descripcion",s),1==t?l.append("tipo","updatePadre"):l.append("tipo","updateHijo"),console.log([...l]);const r=await fetch("http://localhost/gdagmcp/seccion/update",{method:"POST",headers:{token:token},body:l}),d=await r.json();d.exito?Swal.fire({position:"top-end",icon:"success",title:d.exito,showConfirmButton:!1,timer:1500}).then(()=>{$("#exampleModal"+a).modal("hide"),$("#exampleModalEditar"+a).modal("hide"),dibujarHijos(e,d.hijos)}):d.error?Swal.fire({icon:"error",title:"ERROR",text:d.error}).then(()=>{$("#exampleModal"+a).modal("hide"),$("#exampleModalEditar"+a).modal("hide"),dibujarHijos(e,d.hijos)}):d.exit?Swal.fire({icon:"warning",title:d.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(i+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',d.alertas.error.forEach(e=>{i+='<li class="text-danger"  >',i+=e,i+="</li>"}),i+="</ul>",document.getElementById("alertas").innerHTML=i),alertas()}async function deleteSeccion(e){const a=(await traerSecciones()).find(a=>a.id==e);Swal.fire({title:"ELIMINAR",text:`Estas seguro de Eliminar de forma permamente a ${a.seccion}?`,icon:"error",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(a=>{a.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/seccion/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarHijos(e.padre,e.hijos)}):e.error?Swal.fire({icon:"error",title:"ERROR",text:e.error}).then(()=>{dibujarHijos(e.padre,e.hijos)}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp());