const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles,permisosDefault=[{id:"1",nombre:"Leer",status:"false"},{id:"2",nombre:"Escribir",status:"false"}];async function iniciarApp(){secciones=await traerHijos(0),console.log("secciones",secciones),dibujarHijos(0,secciones)}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,n)=>{a.push(n),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerFormularios(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"formularios"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),console.log("asdfhhhj",t.length),0==t.length&&e(a),$.each(t,(i,n)=>{a.push(n),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerHijos(e=0){return new Promise((t,a)=>{let i=[];$.ajax({data:{id:e,tipo:"hijos"},url:URL_BASE+"/seccion/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(i),$.each(e,(a,n)=>{i.push(n),e.length==a+1&&t(i)})}).fail(e=>{a(e)})})}async function dibujarSecciones(){var e="";let t=await traerSecciones();e+='<h1 class="text-black mb-3"><strong>Administrar Secciones</strong></h1>',e+="<section>",e+='<div class="mb-3">',e+='<div class="d-flex justify-content-end">',e+='<a class=" btn btn-primary " onclick="agregarSeccion(0)"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Sección</span></a>',e+="</div>",e+="</div>",e+="</section>",console.log(t),e+='<div class="mt-4 d-flex" style="flex-wrap:wrap">',t.forEach(t=>{0==t.idPadre&&(e+='<div class="p-3 ">',e+='<a class="btn btn-outline-dark" style="border:1px solid" onclick="entrarSeccion('+t.id+')">',e+='<div class="row justify-content-center align-items-center hoverCarpeta widthCarpeta">',e+="<div>",e+='<i class="fa-regular fa-folder-open" style="font-size:40px"></i>',e+='<p class="botonCarpeta">'+t.seccion+"</p>",e+="</div>",e+="</div>",e+="</a>",e+="</div>")}),e+="</div>",document.getElementById("dibujar-js").innerHTML=e}async function dibujarHijos(e,t){console.log("hijos del dibujhar",t);var a="";let i=(await traerSecciones()).find(t=>t.id==e);console.log("seccion Actual",i),a+=null==i?'<h1 class="text-black mb-3"><strong>Administrar Secciones</strong></h1>':'<h1 class="text-black mb-3"><strong>Sección '+i.seccion+"</strong></h1>",a+="<section>",a+='<div class="mt-5 mb-3">',a+='<div class="d-flex justify-content-end">',a+='<a class=" btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" id="'+e+'"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Sección</span></a>',a+="</div>",a+="</div>",a+="</section>",a+='<div class="mt-4 d-flex" style="flex-wrap:wrap">',0==t.length?(a+='<div class="alert bg-danger px-5 py-2 mt-3 w-100" style="border-radius:5px;border:1px solid red">',a+='<div class="d-flex justify-content-center align-items-center">',a+='<h4 class="text-white">No Existen Archivos</h4>',a+="</div>",a+="</div>"):t.forEach(e=>{a+='<div class="p-3 ">',a+='<a class="btn btn-outline-dark" style="border:1px solid" onclick="entrarSeccion('+e.id+')">',a+='<div class="row justify-content-center align-items-center hoverCarpeta widthCarpeta">',a+="<div>",a+='<i class="fa-regular fa-folder-open" style="font-size:40px"></i>',a+='<p class="botonCarpeta">'+e.seccion+"</p>",a+="</div>",a+="</div>",a+="</a>",a+="</div>"}),a+="</div>",a+='<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',a+='<div class="modal-dialog">',a+='<div class="modal-content">',a+='  <div class="modal-header bg-black">',a+='   <h5 class="modal-title text-white">Agregar Sección</h5>',a+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',a+="  </div>",a+='  <div class="modal-body">',a+='<h3 class="text-black mt-2 mb-4">Ingrese los datos de la nueva Sección</h3>',a+="<form>",a+='<div class="mb-3">',a+='<label for="exampleFormControlInput1" class="form-label"><strong>Nombre de la Seccion:</strong></label>',a+='<input type="text" class="form-control" id="seccion" name="seccion" value="">',a+="</div>",a+='<div class="w-100 mt-2" id="alertas">',a+="</div>",a+="</form>",a+="</div>",a+='<div class="modal-footer">',a+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',a+='<a class="btn btn-success" id="botonCrear" onclick="saveSeccion(0)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",document.getElementById("dibujar-js").innerHTML=a}async function entrarSeccion(e){let t=await traerHijos(e);console.log("hijos",t),console.log("id",e),dibujarHijos(e,t)}async function guardarFormulario(e){let t=document.getElementById("formularioSelected"+e).value;var a="";if(""==t)document.getElementById("alertas"+e).classList.remove("apagar"),document.getElementById("btnSaveForm"+e).classList.add("apagar"),document.getElementById("formularioSelected"+e).classList.add("errorInput"),a+='<div class="d-flex justify-content-center align-items-center bg-danger mt-1 py-2 mx-3 text-white" style="font-size:14px;border:1px solid red;border-radius:5px">Debe seleccionar un Formulario</div>',document.getElementById("alertas"+e).innerHTML=a,setTimeout(()=>{document.getElementById("btnSaveForm"+e).classList.remove("apagar"),document.getElementById("formularioSelected"+e).classList.remove("errorInput"),document.getElementById("alertas"+e).classList.add("apagar")},2e3);else{botonesGuardar("btnSaveForm"+e,"px-0","py-0"),$("#exampleModalAddFormulario"+e).modal("hide");const t=new FormData,i=document.getElementById("formularioSelected"+e).value;t.append("idFormulario",i),t.append("idSeccion",e),console.log([...t]);let n=URL_BASE+"/seccion/formulario/agregar";const o=await fetch(n,{method:"POST",headers:{token:token},body:t}),s=await o.json();console.log(s),s.exito?Swal.fire({position:"top-end",icon:"success",title:s.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):s.error?Swal.fire({icon:"error",title:"ERROR",text:s.error}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):s.exit?Swal.fire({icon:"warning",title:s.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(a+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',s.alertas.error.forEach(e=>{a+='<li class="text-danger"  >',a+=e,a+="</li>"}),a+="</ul>",document.getElementById("alertas").innerHTML=a),alertas()}}function botonesGuardar(e,t="px-2",a="py-3"){document.getElementById(e).innerHTML="";let i="";i+='<buttom type="buttom" class="btn d-flex '+t+" "+a+' cursito justify-content-center align-items-center" style="background-color:#198754" disabled>',i+='<span class="spinner-border spinner-border-sm" style="width: 1.8rem; height: 1.8rem;color:white" role="status" aria-hidden="true"></span>',i+='<span style="margin-left:15px;font-size:14px;color:white">Cargando...</span>',i+="</button>",document.getElementById(e).innerHTML=i}async function saveSeccion(e){console.log("id",e);var t="";const a=document.getElementById("seccion").value;console.log("seccion",a);const i=new FormData;i.append("id",e),i.append("seccion",a),i.append("idFormulario","1"),console.log([...i]);const n=await fetch("http://localhost/gdagmcp/seccion/create",{method:"POST",headers:{token:token},body:i}),o=await n.json();o.exito?Swal.fire({position:"top-end",icon:"success",title:o.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):o.error?Swal.fire({icon:"error",title:"ERROR",text:o.error}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):o.exit?Swal.fire({icon:"warning",title:o.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(t+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',o.alertas.error.forEach(e=>{t+='<li class="text-danger"  >',t+=e,t+="</li>"}),t+="</ul>",document.getElementById("alertas").innerHTML=t),alertas()}async function eliminarSeccion(e){const t=(await traerSecciones()).find(t=>t.id==e);console.log(t),Swal.fire({title:"ELIMINAR",text:`La Sección ${t.seccion} se eliminará de forma permanente`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(t=>{t.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/seccion/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):e.error?Swal.fire({icon:"error",title:"ERROR",text:e.error}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable()}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp());