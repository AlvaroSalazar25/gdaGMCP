const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles,formulario,permisosDefault=[{id:"1",nombre:"Leer",status:"false"},{id:"2",nombre:"Escribir",status:"false"}];async function iniciarApp(){console.log("hola"),formulario=await traerFormularios(),console.log("formuarios",formulario),dibujarFormulario(),$("#tablaFormularios").DataTable({language:{url:URL_BASE+"/public/build/js/varios/DataTable_es_es.json"}})}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/unidad/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(o,r)=>{a.push(r),t.length==o+1&&e(a)})}).fail(e=>{t(e)})})}function traerFormularios(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"formularios"},url:URL_BASE+"/formulario/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(o,r)=>{a.push(r),t.length==o+1&&e(a)})}).fail(e=>{t(e)})})}async function dibujarFormulario(e,t=1){var a="";let o=await traerFormularios();console.log(o),a+='<h1 class="text-black mb-3"><strong>Administrar Formularios</strong></h1>',a+="<section>",a+='<div class="mb-3">',a+='<div class="d-flex justify-content-end">',a+='<a class=" btn btn-secondary" style="margin-right:5px" onclick="agregarFormulario(1)"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Formulario</span></a>',a+="</div>",a+="</div>",a+="</section>",a+='<table class="table" style="min-width:900px" id="tablaFormularios">',a+='<thead class="table-dark">',a+='<tr class="" style="text-transform:uppercase">',a+="<th>N°</th>",a+='<th class="">Formulario</th>',a+='<th class="">Versión</th>',a+='<th class="">Campos</th>',a+='<th class="col-2">Acciones</th>',a+="</tr>",a+="</thead>",a+='<tbody class="contenido" id="contenido">',o.forEach((e,t)=>{a+='<tr class="">',a+="<td>"+(parseInt(t)+1)+"</td>",null!=e.idSeccion?a+="<td>"+e.nombre+'<span class="badge rounded-pill bg-success" style="margin-left:10px">Activo</span></td>':a+="<td>"+e.nombre+"</td>",a+="<td>",a+='<div class="puntero" title="Actualizado última vez : '+e.updated_at+'">'+e.version+"</div>",a+="</td>",a+="<td>",a+='<buttom class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalForm'+e.id+'">Ver campos</buttom>',a+="</td>",a+="<td>",a+='<div class="acciones-user">',a+='<a class="btn btn-warning botonAccionesSeccion" style="margin-right:5px" id="'+e.id+'"  onclick="agregarFormulario(2,'+e.id+')"><i class="fa-solid fa-pen-to-square marginIcon"></i>Editar</a>',a+='<a class="btn btn-danger botonAccionesSeccion" onclick="eliminarFormulario('+e.id+')"><i class="fa-solid fa-trash marginIcon"></i>Eliminar</a>',a+="</div>",a+="</td>",a+='<div class="modal fade" id="exampleModalForm'+e.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',a+='<div class="modal-dialog modal-dialog-centered">',a+='<div class="modal-content">',a+='<div class="modal-header">',a+='<h5 class="modal-title" id="exampleModalLabel">Campos de Formulario '+e.nombre.toUpperCase()+"</h5>",a+='<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>',a+="</div>",a+='<div class="modal-body">';const o=JSON.parse(e.campos),r=JSON.parse(e.keywords);a+='<div class=" w-100 mb-3">',a+='<label class="form-label"><strong>'+r.input+"</strong></label>",a+='<div class="input-group ">',a+='<span class="input-group-text" id="basic-addon1"><i class="fa-solid fa-a"></i></span>',a+='<input type="'+r.type+'" class="form-control cursito" placeholder="Ingrese el valor para '+r.input+'" disabled>',a+="</div>",a+="</div>",a+='<div class="w-100 mb-3">',o.forEach(e=>{a+='<div class="row">',a+='<label class="form-label"><strong>'+e.input+"</strong></label>",a+='<div class="input-group ">',"text"==e.type?a+='<span class="input-group-text" id="basic-addon1"><i class="fa-solid fa-pen"></i></span>':a+='<span class="input-group-text" id="basic-addon1"><i class="fa-regular fa-calendar"></i></span>',a+='<input type="'+e.type+'" class="form-control cursito" placeholder="Ingrese el valor para '+e.input+'" disabled>',a+="</div>",a+="</div>"}),a+="</div>",a+='<div class=" mb-3">',a+='<label class="form-label"><strong>Archivo</strong></label>',a+='<div class="input-group">',a+='<input type="file" class="form-control cursito"  disabled>',a+="</div>",a+="</div>",a+='<div class="modal-footer">',a+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',a+="</div>",a+="</div>",a+="</div>",a+="</div>"}),a+="</tbody>",a+="</table>",document.getElementById("dibujar-js").innerHTML=a,$("#tablaFormularios").DataTable({language:{url:URL_BASE+"/public/build/js/varios/DataTable_es_es.json"}})}async function agregarFormulario(e=1,t){var a="";let o=await traerFormularios();if("2"==e){var r=o.find(e=>e.id==t);console.log("oppp",r)}let l="";l=r?r.nombre:"",a+='<h1 class="text-black mb-3"><strong>Administrar Formularios</strong></h1>',a+='<div class="contenedor-crearUsuario bg-light ">',a+="2"==e?'<h3 class="text-black mt-2 mb-4">Edite los datos del formulario <strong>'+l+"</strong></h3>":'<h3 class="text-black mt-2 mb-4">Ingrese los datos del nuevo Formulario</h3>',a+='<div class="mb-3">',a+='<label class="form-label"><strong>Nombre de Formulario:</strong></label>',a+='<input type="text" class="form-control" id="nombreFormulario" name="nombreFormulario" value="'+l+'" placeholder="Ingrese nombre del formulario" aria-label="Username" aria-describedby="basic-addon1">',a+="</div>",a+='<div class="accordion mb-3" id="accordionExample1">',a+='<div class="accordion-item">',a+='<h2 class="accordion-header" id="headingOne">',a+='<button class="accordion-button collapsed"  type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne1" aria-expanded="false" aria-controls="collapseOne">',a+='<label for="exampleFormControlInput1" class="form-label"><strong>Keywords</strong></label>',a+="</button>",a+="</h2>",a+='<div id="collapseOne1" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample1" style="">',a+=' <div class="accordion-body">',a+='<label class="form-label"><strong>Campo para ingresar palabras clave</strong></label>',a+='<div class="mb-3" style="border-radius:5px;">',a+='<div class="d-flex w-100 justify-content-center">',a+='<input type="text" class="form-control cursito" style="margin-right:5px" name="keywords" disabled placeholder="* Campo Obligatorio">',a+='<select class="form-select cursito mr-1" name="keywords" >',a+='<option value="text" selected disabled>text</option>',a+="</select>",a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+='<div class="accordion" id="accordionExample">',a+='<div class="accordion-item">',a+='<h2 class="accordion-header" id="headingOne">',a+='<button class="accordion-button collapsed" id="errorArchivo" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">',a+='<label for="exampleFormControlInput1" class="form-label"><strong>Archivo</strong></label>',a+="</button>",a+="</h2>",a+='<div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample" style="">',a+=' <div class="accordion-body" id="errorArchivoBody">',a+='<div class="mb-3">',a+='<label for="exampleFormControlInput1" class="form-label "><strong>Archivo:</strong></label>',a+='<input class="form-control cursito disabled" type="file" name="archivo" id="archivo">',a+="</div>",a+='<label for="exampleFormControlInput1" class="form-label"><strong>Seleccione los tipos de archivos que se pueden subir:</strong></label>',a+='<div class="mb-3 row">';let s=["PDF","DOC","ODF","XLSX","PNG","JPEG"];if("2"==e){let e=JSON.parse(r.archivo).map(e=>e.toUpperCase());s.forEach(t=>{a+='<div class="d-flex justify-content-start align-items-center" >',a+='<label style="width:50px"  class="form-label">'+t+":</label>";let o=e.find(e=>e==t);console.log("filtro",o),a+=null!=o?'<input class="checks" checked type="checkbox" value="'+t.toLowerCase()+'">':'<input class="checks" type="checkbox" value="'+t.toLowerCase()+'">',a+="</div>"})}else s.forEach(e=>{a+='<div class="d-flex justify-content-start align-items-center" >',a+='<label style="width:50px"  class="form-label">'+e+":</label>",a+="PDF"==e||"DOC"==e?'<input class="checks" type="checkbox" checked value="'+e.toLowerCase()+'">':'<input class="checks" type="checkbox" value="'+e.toLowerCase()+'">',a+="</div>"});a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+='<div class="mb-3 mt-3">',a+='<label for="exampleFormControlInput1" class="form-label"><strong>Campos Personalizados:</strong></label>',a+='<div class="bg-white" id="emptyInputs"  style="min-height:150px;border:1px solid #dde1e6;border-radius:5px">',a+='<div class="w-100 mb-3 mt-4" id="dinamicCampo">';let i=1;if("2"==e){JSON.parse(r.campos).forEach(e=>{a+='<div class=" divCrear">',a+='<div class="d-flex justify-content-center align-items-center" style="font-size:13px"><p>'+i+"</p></div>",a+='<input class="form-control impt" type="text" id="nombresInputs" value="'+e.input+'" placeholder="Ingrese nombre de campo">',a+='<select class="form-select sltd" id="selectInputs">',a+='<option value="" selected disabled> -- Seleccione el tipo de campo -- </option>',"text"==e.type?(a+='<option value="text" selected>Text</option>',a+='<option value="date">Date</option>'):(a+='<option value="text">Text</option>',a+='<option value="date" selected>Date</option>'),a+="</select> ",a+='<button class="btn btn-danger" onclick="eliminar(this)"><i class="fa-solid fa-trash-can"></i></button>',i++,a+="</div>"})}a+="</div>",a+='<div class="d-flex justify-content-center align-items-center btnAltura mb-3"  id="botonAltura">',a+='<buttom style="font-size:15px" class="btn btn-rounded btn-primary" id="agregar" onclick="agregarCampo(2,'+i+')"><i class="fa-solid fa-plus" style="margin-right:5px;"></i>Agregar campo</buttom>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+='<div class="dibujar-formulario">',a+="</div>",a+='<div class="w-100 mt-2" id="alertas">',a+="</div>",a+='<div class="my-5 d-flex justify-content-center align-items-center" id="botonCrear">',a+='<a class="btn btn-success py-3 px-4 d-flex justify-content-center align-items-center" style="font-size:15px" onclick="guardarInputs('+e+","+t+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',a+="</div>",a+='<div class=" d-flex justify-content-start align-items-center">',a+='<a class="btn btn-outline-danger px-3 py-1" id="botonCrear" style="font-size:15px" onclick="dibujarFormulario()"><i class="fa-solid fa-arrow-left"></i> <span style="margin-left:8px">Atrás</span></a>',a+="</div>",a+="</div>",document.getElementById("dibujar-js").innerHTML=a}async function guardarFormulario(e){let t=document.getElementById("formularioSelected"+e).value;var a="";if(""==t)document.getElementById("alertas"+e).classList.remove("apagar"),document.getElementById("btnSaveForm"+e).classList.add("apagar"),document.getElementById("formularioSelected"+e).classList.add("errorInput"),a+='<div class="d-flex justify-content-center align-items-center bg-danger mt-1 py-2 mx-3 text-white" style="font-size:14px;border:1px solid red;border-radius:5px">Debe seleccionar un Formulario</div>',document.getElementById("alertas"+e).innerHTML=a,setTimeout(()=>{document.getElementById("btnSaveForm"+e).classList.remove("apagar"),document.getElementById("formularioSelected"+e).classList.remove("errorInput"),document.getElementById("alertas"+e).classList.add("apagar")},2e3);else{botonesGuardar("btnSaveForm"+e,"px-0","py-0"),$("#exampleModalAddFormulario"+e).modal("hide");const t=new FormData,o=document.getElementById("formularioSelected"+e).value;t.append("idFormulario",o),t.append("idSeccion",e),console.log([...t]);let r=URL_BASE+"/seccion/formulario/agregar";const l=await fetch(r,{method:"POST",headers:{token:token},body:t}),s=await l.json();console.log(s),s.exito?Swal.fire({position:"top-end",icon:"success",title:s.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable({language:{url:URL_BASE+"/public/build/js/varios/DataTable_es_es.json"}})}):s.error?Swal.fire({icon:"error",title:"ERROR",text:s.error}).then(()=>{dibujarSecciones(),$("#tablaSecciones").DataTable({language:{url:URL_BASE+"/public/build/js/varios/DataTable_es_es.json"}})}):s.exit?Swal.fire({icon:"warning",title:s.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(a+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',s.alertas.error.forEach(e=>{a+='<li class="text-danger"  >',a+=e,a+="</li>"}),a+="</ul>",document.getElementById("alertas").innerHTML=a),alertas()}}async function eliminarFormulario(e){const t=(await traerFormularios()).find(t=>t.id==e);console.log(t),Swal.fire({title:"ELIMINAR",text:`El Formulario ${t.nombre} se eliminará de forma permanente`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(t=>{t.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/formulario/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarFormulario()}):e.error?Swal.fire({icon:"error",title:"ERROR",text:e.error}).then(()=>{dibujarFormulario()}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}function agregarCampo(e,t){let a;document.getElementById("emptyInputs").classList.remove("errorInput"),a="1"==e?1:t;const o=document.querySelector("#dinamicCampo");var r="";let l=document.createElement("div");r+='<div class="d-flex justify-content-center align-items-center" style="font-size:13px"><p>'+a+"</p></div>",r+='<input class="form-control impt" type="text" id="nombresInputs" placeholder="Ingrese nombre de campo">',r+='<select class="form-select sltd" id="selectInputs">',r+='<option value="" selected disabled> -- Seleccione el tipo de campo -- </option>',r+='<option value="text">Text</option>',r+='<option value="date">Date</option>',r+="</select> ",r+='<button class="btn btn-danger" onclick="eliminar(this)"><i class="fa-solid fa-trash-can"></i></button>',l.innerHTML=r,l.classList.add("divCrear"),o.appendChild(l),document.getElementById("botonAltura").classList.remove("btnAltura"),actualizarContador()}document.addEventListener("DOMContentLoaded",iniciarApp()),eliminar=e=>{console.log(e.parentNode);const t=document.querySelector("#dinamicCampo"),a=e.parentNode;t.removeChild(a),actualizarContador()};const actualizarContador=()=>{let e=document.querySelector("#dinamicCampo").children;total=1;for(let t=0;t<e.length;t++)e[t].children[0].innerHTML=total+++"-"};async function guardarInputs(e,t){let a=[],o=0;document.querySelectorAll(".checks").forEach(e=>{1==e.checked&&("doc"==e.value?(a.push(e.value),a.push("docs")):a.push(e.value))}),console.log("numdetipos",a.length),console.log("tipos de archivos",a),0==a.length?(document.getElementById("errorArchivo").classList.add("errorAccordeon"),document.getElementById("errorArchivoBody").classList.add("errorInput"),o++):(document.getElementById("errorArchivo").classList.remove("errorAccordeon"),document.getElementById("errorArchivoBody").classList.remove("errorInput"));let r=document.getElementById("nombreFormulario").value.trim(),l=document.getElementById("dinamicCampo");0==r.length?(document.getElementById("nombreFormulario").classList.add("errorInput"),o++):document.getElementById("nombreFormulario").classList.remove("errorInput"),0==l.children.length?(document.getElementById("emptyInputs").classList.add("errorInput"),o++):document.getElementById("emptyInputs").classList.remove("errorInput");let s=[];document.querySelectorAll(".impt").forEach(e=>{""==e.value?(o++,e.classList.add("errorInput")):(e.classList.remove("errorInput"),s.push(e.value))});let i=[];document.querySelectorAll(".sltd").forEach(e=>{""==e.value?(o++,e.classList.add("errorInput")):(e.classList.remove("errorInput"),i.push(e.value))});let n=[];for(let e=0;e<s.length;e++)n.push({input:s[e],type:i[e]});if(o>0){document.getElementById("alertas").classList.remove("apagar");let e="";e+='<div class="d-flex justify-content-center align-items-center bg-danger mt-5 py-2 text-white" style="font-size:15px;border:1px solid red;border-radius:5px">No pueden ir campos vacíos</div>',document.getElementById("alertas").innerHTML=e,setTimeout(()=>{document.getElementById("botonCrear").classList.remove("apagar"),document.getElementById("alertas").classList.add("apagar")},2e3),document.getElementById("botonCrear").classList.add("apagar")}else{botonesGuardar("botonCrear","px-3","py-2");const o=new FormData;let l;"2"==e&&o.append("id",t),o.append("nombre",r),o.append("keywords",JSON.stringify({input:"keywords",type:"text"})),o.append("archivo",JSON.stringify(a)),o.append("campos",JSON.stringify(n)),console.log([...o]),l="1"==e?URL_BASE+"/formulario/create":URL_BASE+"/formulario/update";const s=await fetch(l,{method:"POST",headers:{token:token},body:o}),i=await s.json();console.log(i),i.exito?Swal.fire({position:"top-end",icon:"success",title:i.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarFormulario()}):i.error?Swal.fire({icon:"error",title:"ERROR",text:i.error}).then(()=>{dibujarFormulario()}):i.exit?Swal.fire({icon:"warning",title:i.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(html+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',i.alertas.error.forEach(e=>{html+='<li class="text-danger"  >',html+=e,html+="</li>"}),html+="</ul>",document.getElementById("alertas").innerHTML=html),alertas()}}function botonesGuardar(e,t="px-2",a="py-3"){document.getElementById(e).innerHTML="";let o="";o+='<buttom type="buttom" class="btn d-flex '+t+" "+a+' cursito justify-content-center align-items-center" style="background-color:#198754" disabled>',o+='<span class="spinner-border spinner-border-sm" style="width: 1.8rem; height: 1.8rem;color:white" role="status" aria-hidden="true"></span>',o+='<span style="margin-left:15px;font-size:14px;color:white">Cargando...</span>',o+="</button>",document.getElementById(e).innerHTML=o}