const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles,permisosDefault=[{id:"1",nombre:"Leer",status:"false"},{id:"2",nombre:"Escribir",status:"false"}];async function iniciarApp(){unidades=await traerUnidades(),secciones=await traerSecciones(),console.log("asdfasdf",unidades),dibujarUnidades(unidades)}function alertas(){const e=document.querySelectorAll(".alert"),i=document.getElementById("alertas"),t=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),i&&(i.innerHTML=""),t&&(t.innerHTML="")}))},3e3)}function traerUnidades(){return new Promise((e,i)=>{let t=[];$.ajax({data:{tipo:"unidadSeccion"},url:URL_BASE+"/unidad/datos",type:"POST",headers:{token:token},dataType:"json"}).done(i=>{i.exit&&Swal.fire({icon:"warning",title:i.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==i.length&&e(t),$.each(i,(a,n)=>{t.push(n),i.length==a+1&&e(t)})}).fail(e=>{i(e)})})}function traerSecciones(){return new Promise((e,i)=>{let t=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/unidad/datos",type:"POST",headers:{token:token},dataType:"json"}).done(i=>{i.exit&&Swal.fire({icon:"warning",title:i.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==i.length&&e(t),$.each(i,(a,n)=>{t.push(n),i.length==a+1&&e(t)})}).fail(e=>{i(e)})})}async function dibujarUnidadesUpdate(){dibujarUnidades(await traerUnidades())}function dibujarUnidades(e){var i="";i+="<section>",i+='<div class="mb-3">',i+='<div class="d-flex justify-content-end">',i+='<a class=" btn btn-primary " onclick="agregarUnidad()"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Unidad</span></a>',i+="</div>",i+="</div>",i+="</section>",i+='<table class="table" style="min-width:900px" id="tablaUnidades">',i+='<thead class="table-dark">',i+='<tr class="" style="text-transform:uppercase">',i+="<th>N°</th>",i+='<th class="">Unidad</th>',i+='<th class="">Jefe</th>',i+='<th class="col-2">Sección</th>',i+='<th class="col-2">Permisos</th>',i+='<th class="col-2">Acciones</th>',i+="</tr>",i+="</thead>",i+='<tbody class="contenido" id="contenido">',e.forEach((e,t)=>{var a=[];i+='<tr class="">',i+="<td>"+(parseInt(t)+1)+"</td>",i+="<td>"+e.unidad+"</td>",i+="<td>"+e.jefe+"</td>";const n=JSON.parse(e.seccion);i+="<td>",0==n.length?i+='<p class="text-danger" style="font-size:13px;margin-right:10px">Sin secciones</p>':(i+='<ul class="ultimoNo" style="height:44px;margin-bottom:0px;">',n.forEach((e,t)=>{i+='<li  style="font-size:14px;margin-bottom:10px">'+e.seccion+"</li>";const n=JSON.parse(e.permisos);a.push(n)}),i+="</ul>"),i+="</td>",i+="<td>";var s=0;0==a.length?i+='<p class="text-danger" style="font-size:13px">Sin Permisos</p>':(a.forEach(t=>{i+='<div class="dropend" style="margin-bottom:5px">',i+='<button class="btn btn-secondary dropdown-toggle" id="dropdownMenu'+e.id+s+'" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Ver Permisos</button>',i+='<div class="dropdown-menu dropdown-menu-dark" aria-labelledby="dropdownMenu'+e.id+s+'">',t.forEach(e=>{"true"==e.status?(i+='<p  class="dropdown-item"><i class="fa-solid fa-check text-success" style="margin-right:8px"></i>'+e.nombre+"</p>",i+='<div class="ultimoNo "></div>'):(i+='<p  class="dropdown-item"><i class="fa-solid fa-xmark text-danger" style="margin-right:8px"></i>'+e.nombre+"</p>",i+='<div class="ultimoNo "></div>')}),i+=" </div>",i+="</div>",s++}),i+="</td>"),i+="<td>",i+='<div class="acciones-user">',i+='<a class="btn btn-warning botonAccionesUnidad" id="'+e.id+'"  onclick="agregarUnidad(2,'+e.id+')"><i class="fa-solid fa-pen-to-square marginIcon"></i>Editar</a>',i+='<a class="btn btn-danger botonAccionesUnidad" onclick="eliminarUnidad('+e.id+')"><i class="fa-solid fa-trash marginIcon"></i>Eliminar</a>',i+="</div>",i+="</td>"}),i+="</tbody>",i+="</table>",document.getElementById("dibujar-js").innerHTML=i,$("#tablaUnidades").DataTable()}async function agregarUnidad(e=1,i){var t="",a=await traerUnidades();if("2"==e)var n=a.find(e=>e.id==i),s=JSON.parse(n.seccion),d=n.unidad,o=n.jefe;d||o||(d="",o=""),t+='<div class="contenedor-crearUsuario bg-light ">',t+="2"==e?'<h3 class="text-black mt-2 mb-4">Edite los datos de '+d+"</h3>":'<h3 class="text-black mt-2 mb-4">Ingrese los datos de la nueva Unidad</h3>',t+="<form>",t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Nombre:</strong></label>',t+='<input type="text" class="form-control" id="unidad" name="unidad" value="'+d+'" placeholder="Ingrese nombre de la unidad" aria-label="Username" aria-describedby="basic-addon1">',t+="</div>",t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Jefe:</strong></label>',t+='<input type="text" class="form-control" id="jefe" name="jefe" value="'+o+'" placeholder="Ingrese nombre de Jefe" aria-label="Username" aria-describedby="basic-addon1">',t+="</div>",t+='<h4 class="text-black mt-4 mb-4">Permisos de Unidad</h4>',t+='<div class="bg-white py-3 px-2" style="border-radius:8px;border:1px solid #e0e4e7">',"2"==e?secciones.forEach(e=>{let i=s.find(i=>i.idSeccion==e.id);null!=i?(t+='<div class="d-flex" style="font-size:15px;margin-bottom:5px" >',t+='<div class="d-flex" style="width:200px;justify-content:start;align-items:center">',t+='<input class="secciones" type="checkbox" checked id="'+e.id+'" name="'+e.seccion+'" value="'+e.id+'">',t+=' <label style="margin-left:5px">'+e.seccion+"</label>",t+="</div>",t+='<div class="d-flex justify-content-center" id="contenedor'+e.id+'" style="font-size:13px;border:1px solid #ced4da;padding:5px 0px 5px 10px">',permisosDefault.forEach(e=>{let a=JSON.parse(i.permisos).find(i=>i.id==e.id);null!=a?"true"==a.status?(t+='<input style="margin-right:5px" type="checkbox" checked  id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',t+=' <label style="margin-right:10px" >'+e.nombre+"</label>"):(t+='<input style="margin-right:5px" type="checkbox"   id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',t+=' <label style="margin-right:10px" >'+e.nombre+"</label>"):(t+='<input style="margin-right:5px" type="checkbox"  id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',t+=' <label style="margin-right:10px" >'+e.nombre+"</label>")}),t+="</div>",t+="</div>"):(t+='<div class="d-flex" style="font-size:15px;margin-bottom:5px" >',t+='<div class="d-flex" style="width:200px;justify-content:start;align-items:center">',t+='<input class="secciones" type="checkbox" id="'+e.id+'" name="'+e.seccion+'" value="'+e.id+'">',t+=' <label style="margin-left:5px">'+e.seccion+"</label>",t+="</div>",t+='<div class="d-flex justify-content-center visiblePermiso" id="contenedor'+e.id+'" style="font-size:13px;border:1px solid #ced4da;padding:5px 0px 5px 10px">',permisosDefault.forEach(e=>{t+='<input style="margin-right:5px" type="checkbox"  id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',t+=' <label style="margin-right:10px" >'+e.nombre+"</label>"}),t+="</div>",t+="</div>")}):secciones.forEach(e=>{t+='<div class="d-flex" style="font-size:15px;margin-bottom:5px" >',t+='<div class="d-flex" style="width:200px;justify-content:start;align-items:center">',t+='<input class="secciones" type="checkbox" id="'+e.id+'" name="'+e.seccion+'" value="'+e.id+'">',t+=' <label style="margin-left:5px">'+e.seccion+"</label>",t+="</div>",t+='<div class="d-flex justify-content-center visiblePermiso" id="contenedor'+e.id+'" style="font-size:13px;border:1px solid #ced4da;padding:5px 0px 5px 10px">',permisosDefault.forEach(e=>{t+='<input style="margin-right:5px" type="checkbox"  id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',t+=' <label style="margin-right:10px" >'+e.nombre+"</label>"}),t+="</div>",t+="</div>"}),t+="</div>",t+='<div class="w-100 mt-2" id="alertas">',t+="</div>",t+='<div class="my-5 d-flex justify-content-center align-items-center">',t+='<a class="btn btn-success px-5 py-2" id="botonCrear" style="font-size:15px" onclick="guardarUnidad('+e+","+i+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+='<div class=" d-flex justify-content-start align-items-center">',t+='<a class="btn btn-outline-danger px-3 py-1" id="botonCrear" style="font-size:15px" onclick="dibujarUnidadesUpdate()"><i class="fa-solid fa-arrow-left"></i> <span style="margin-left:8px">Atrás</span></a>',t+="</div>",t+="</form>",t+="</div>",document.getElementById("dibujar-js").innerHTML=t}async function guardarUnidad(e,i){let t=document.getElementById("unidad").value,a=document.getElementById("jefe").value,n=[];secciones.forEach(e=>{let i=document.getElementById(e.id);1==i.checked&&n.push({id:i.id,seccion:i.name})});let s=[];var d=[];if(n.forEach(e=>{let i=document.getElementById("contenedor"+e.id),t=[];var a=0;for(let n=0;n<i.children.length;n++)if(1==i.children[n].checked)null!=i.children[n].value&&t.push({id:i.children[n].value,nombre:i.children[n].name,status:"true"});else if(null!=i.children[n].value){if(2==++a){let i="No se a seleccionado permisos para la sección de "+e.seccion;d.push(i)}t.push({id:i.children[n].value,nombre:i.children[n].name,status:"false"})}s.push({idSeccion:e,idPermisos:t})}),0!=d.length){let e="";return e+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',d.forEach(i=>{e+='<li class="text-danger"  >',e+=i,e+="</li>"}),e+="</ul>",document.getElementById("alertas").innerHTML=e,void alertas()}{const n=new FormData;let r;"2"==e&&n.append("id",i),n.append("unidad",t),n.append("jefe",a),console.log("errir",d),n.append("permisos",JSON.stringify(s)),console.log([...n]),r="2"==e?URL_BASE+"/unidad/actualizar":URL_BASE+"/unidad/create";const l=await fetch(r,{method:"POST",headers:{token:token},body:n}),c=await l.json();var o="";console.log(c),c.exito?Swal.fire({position:"top-end",icon:"success",title:c.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarUnidadesUpdate()}):c.error?Swal.fire({icon:"error",title:"ERROR",text:c.error}).then(()=>{agregarUnidad()}):c.exit?Swal.fire({icon:"warning",title:c.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(o+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',c.alertas.error.forEach(e=>{o+='<li class="text-danger"  >',o+=e,o+="</li>"}),o+="</ul>",document.getElementById("alertas").innerHTML=o),alertas()}}async function eliminarUnidad(e){const i=unidades.find(i=>i.id==e);console.log(i),Swal.fire({title:"ELIMINAR",text:`Eliminar de forma permamente a ${i.unidad}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(i=>{i.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/unidad/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarUnidadesUpdate()}):e.error?Swal.fire({icon:"error",title:"ERROR",text:e.error}).then(()=>{dibujarUnidadesUpdate()}):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp()),document.addEventListener("click",(function(e){if(e.target.classList.contains("secciones")){let i=e.target;console.log("contenedor"+i.id);let t=document.getElementById("contenedor"+i.id);if(1==i.checked)t.classList.toggle("visiblePermiso");else{t.classList.toggle("visiblePermiso");for(let e=0;e<t.children.length;e++)t.children[e].checked=!1}}}));