const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token")),CARPETA_BASE="/base";let unidades,secciones,roles;async function iniciarApp(){await dibujarCarpetas();let e=generarCarpetas(0,await traerSecciones());const t=document.getElementById("contenedor-carpetas"),a=dibujarArbolCarpetas(e,t);t.append(a)}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}async function dibujarCarpetas(){document.getElementById("contenedor-titulo").innerHTML='<h1 class="text-black"><strong>Administrar Permisos</strong></h1> <h3 class="text-black mt-3 mb-4">Seleccione una carpeta para elegir los permisos</h3>';const e=document.createElement("div");e.id="contenedor-carpetas",e.classList.add("contenedor-carpetas","mt-4","py-5","px-3");document.getElementById("dibujar-js").appendChild(e)}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(s,i)=>{a.push(i),t.length==s+1&&e(a)})}).fail(e=>{t(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp());let permisosDefault=[{id:1,nombre:"Ver_Carpeta",type:"carpeta",descripcion:"Permiso para visualizar la carpeta",status:!1},{id:2,nombre:"Crear_Carpeta",type:"carpeta",descripcion:"Permiso para crear carpetas",status:!1},{id:3,nombre:"Editar_Carpeta",type:"carpeta",descripcion:"Permiso para Editar,Mover,Eliminar la carpeta",status:!1},{id:4,nombre:"Ver_Documento",type:"documento",descripcion:"Permiso para visualizar el documento",status:!1},{id:5,nombre:"Crear_Documento",type:"documento",descripcion:"Permiso para Crear un documento",status:!1},{id:6,nombre:"Editar_Documento",type:"documento",descripcion:"Permiso para Editar la metadata del documento",status:!1},{id:7,nombre:"Mover_Documentos",type:"documento",descripcion:"Permiso para mover de carpeta los documentos",status:!1},{id:8,nombre:"Eliminar_Documento",type:"documento",descripcion:"Permiso para Eliminar el documento",status:!1}];function dibujarArbolCarpetas(e,t){let a=e.nombre[0].toUpperCase()+e.nombre.substring(1);const s=document.createElement("ul");s.style="list-style-type:none;";const i=document.createElement("li");if(i.id="li"+e.id,0==e.hijos.length)i.innerHTML=`\n        <div class="d-flex align-items-center mt-1 mb-2" style="font-size:15px">\n        <div id="carpeta${e.id}">\n        <a class="moverC" style="text-decoration:none ;cursor:pointer" onclick="dibujarCarpeta(${e.id})">\n        <i class="fa-solid fa-folder-open fa-lg" style="margin-right:7px;color:${e.color}"></i>\n        <span style="color:#212529"><strong>${a}</strong></span>\n        </a>\n        </div>\n        </div>\n      `;else{let t;t=0==e.id?'<i class="fa-solid fa-chevron-up  fa-lg"></i>':'<i class="fa-solid fa-chevron-down  fa-lg"></i>',i.innerHTML=`\n        <div class="d-flex align-items-center mt-1 mb-2" style="font-size:15px">\n        <div id="carpeta${e.id}">\n        <a class="moverC"  style="text-decoration:none;cursor:pointer" onclick="dibujarCarpeta(${e.id})">\n        <i class="fa-solid fa-folder-open fa-lg" style="margin-right:7px;color:${e.color}"></i>\n        <span style="color:#212529"><strong>${a}</strong></span>\n        </a>\n          <button class="btn btn-link" type="button" id="boton${e.id}" data-bs-toggle="collapse" data-bs-target="#collapse-${e.id}" style="margin-left:12px" >\n          ${t}\n          </button>\n        </div>\n        </div>\n      `}if(s.appendChild(i),e.hijos.length>0){const t=document.createElement("div");t.id="collapse-"+e.id,0==e.id?t.classList.add("show"):t.classList.add("collapse");const a=document.createElement("ul");a.classList.add("list-group","ms-3","mb-3"),e.hijos.forEach(e=>{const t=dibujarArbolCarpetas(e);a.appendChild(t)}),t.appendChild(a),i.appendChild(t);const s=i.querySelector("#boton"+e.id),o=i.querySelector("#carpeta"+e.id);s.addEventListener("click",()=>{if(s.childNodes[1].classList.contains("fa-chevron-down")){o.classList.add("contenedor-carpetas-permiso","px-3");let e=document.createElement("i");e.classList.add("fa-solid","fa-chevron-up","fa-xl"),s.replaceChild(e,s.childNodes[1])}else if(s.childNodes[1].classList.contains("fa-chevron-up")){o.classList.remove("contenedor-carpetas-permiso","px-3");let e=document.createElement("i");e.classList.add("fa-solid","fa-chevron-down","fa-xl"),s.replaceChild(e,s.childNodes[1])}})}return s}function generarCarpetas(e,t){let a=t.find(t=>t.id==e);if(null==a)var s={nombre:"BASE",id:"0",color:"#212529",hijos:[]};else s={nombre:a.seccion,id:a.id,color:a.color,hijos:[]};return t.filter(t=>t.idPadre==e).forEach(e=>{let a=generarCarpetas(e.id,t);s.hijos.push(a)}),s}function traerSeccion(e){return new Promise((t,a)=>{$.ajax({data:{tipo:"findCarpeta",id:e},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{a(e)})})}function traerUsers(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"usuarios"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(s,i)=>{a.push(i),t.length==s+1&&e(a)})}).fail(e=>{t(e)})})}async function dibujarCarpeta(e){var t="";document.getElementById("contenedor-titulo").innerHTML="";let a=await traerSeccion(e);if(t+='<div class="d-flex justify-content-center padreAtras">',t+='<div class="d-flex justify-content-center hijoAtras">',t+='<a class=" btn btn-outline-danger '+(null==a?"noVisible":"")+' " onclick="dibujarAtras('+padre+')"><i class="fa-solid fa-arrow-left-long fa-2x"></i> <span class="span-boton">Atrás</span></a>',t+="</div>",null==a?t+='<h1 class="text-black mb-3"><strong>Administrar Carpetas</strong></h1>':(t+='<div class="d-flex flex-column justify-content-center">',t+='<div class="d-flex justify-content-center">',t+='<h1 class="text-black mb-3"><i class="fa-solid fa-folder-open fa-xl" style="margin-right:7px;color:'+a.color+'"></i><strong>'+(a.seccion[0].toUpperCase()+a.seccion.substring(1))+"</strong></h1>",t+='<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" style="margin-left:5px;margin-top:4px;width:25px;height:30px;border-radius:15px">',t+='<i class="fa-solid fa-ellipsis-vertical fa-xl "></i>',t+="</button>",t+='<ul class="dropdown-menu dropdown-menu-dark">',t+=' <li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModalEditar'+a.id+'"><i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>Editar</a></li>',t+='<li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+a.id+')"><i class="fa-solid fa-trash" style="margin-right:7px"></i>Eliminar</a></li>',t+="</ul>",t+="</div>",t+='<h3 class="text-black mt-3 mb-4">Lista de usuarios permitidos para interactuar con la carpeta seleccionada</h3>',t+="</div>"),t+="</div>",t+='<div class="w-100 mt-2">',null!=a){let e=("/base"+a.path).split("/");e.shift();e.forEach(e=>{var a=e.replaceAll("_"," ");console.log("nombre",a),t+='<a class="" style="text-decoration:none!important;color:#969798"><strong>'+(a[0].toUpperCase()+a.substring(1))+"</strong></a> /  "})}t+="</div>",t+='<div class="contenedor-carpetas mt-3 mb-5 py-3 px-4" style="min-width:900px" id="contenedorCarpetas" >',t+="</div>",t+='<div class="modal fade" id="exampleModalEditar'+a.id+'" tabindex="-1" aria-labelledby="exampleModalLabel'+a.id+'" aria-hidden="true">',t+='<div class="modal-dialog">',t+='<div class="modal-content">',t+='  <div class="modal-header bg-black">',t+='   <h5 class="modal-title text-white">Editar</h5>',t+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',t+="  </div>",t+='  <div class="modal-body" style="min-height:350px">',t+='<h3 class="text-black mt-2 mb-4">Edite <strong>'+a.seccion+"</strong></h3>",t+='<div class="mb-4 d-flex justify-content-between">',t+='<div class="d-flex flex-column" style="width:70%">',t+='<label  class="form-label"><strong>Nombre:</strong></label>',t+='<input type="text" class="form-control" id="seccion'+a.id+'" value="'+a.seccion+'">',t+="</div>",t+='<div class="d-flex flex-column" style="width:28%">',t+='<label class="form-label"><strong>Color:</strong></label>',t+='<input type="color" class="form-control  puntero" id="color'+a.id+'" value="'+a.color+'">',t+="</div>",t+="</div>",t+='<div class="mb-4">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Descripción:</strong></label>',""==a.descripcion?t+='<textarea class="form-control" rows="6" id="descripcion'+a.id+'" placeholder="Esta Sección no tiene descripción"></textarea>':t+='<textarea class="form-control" rows="6" id="descripcion'+a.id+'" >'+a.descripcion+"</textarea>",t+="</div>",t+='<div class="mb-4">',t+='<div class="w-100">',t+='<label class="form-label"><strong>Mover Carpeta:</strong></label>',t+="</div>",t+='<div style="height:30px">',t+='<select style="width:100%;height:100% !important" id="select'+a.id+'" class="js-example-basic-single" >';let s=JSON.parse(a.carpetas);s.unshift({id:"0",idPadre:"0",seccion:"CARPETA BASE",descripcion:"",color:"#000000",path:"/base"}),s.forEach(e=>{e.id!=a.id&&(t+='<optgroup label="'+e.seccion+'">',t+='<option value="'+e.id+'" '+(e.id==a.idPadre?"selected":"")+'><strong><i class="fa-solid fa-folder-open"></i></strong>'+e.path+"</option>",t+="</optgroup>")}),t+="</select>",t+="</div>",t+='<div class="w-100 mt-4" id="alertas'+a.id+'">',t+="</div>",t+="</div>",t+="</div>",t+='<div class="modal-footer">',t+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',t+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+padre+","+a.id+',2)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',t+="</div>",t+="</div>",t+="</div>",t+="</div>",document.getElementById("dibujar-js").innerHTML=t,document.getElementById("dibujar-tabla").innerHTML="",waitResponse("#contenedorCarpetas"),$("#select"+e).select2({dropdownParent:$("#exampleModalEditar"+e)}),await dibujarUsers("contenedorCarpetas",e)}async function dibujarUsers(e,t,a=1,s=[]){0==s.length&&(s=await traerUsers());var i="";i+='<table class="table" style="min-width:900px" id="tablaUsuarios">',i+='<thead class="table-dark">',i+='<tr class="" style="text-transform:uppercase">',i+="<th >N°</th>",i+="<th>Nombre</th>",i+="<th>Rol</th>",i+="<th>Unidad</th>",i+="<th>Estado</th>",i+='<th class="col-1">Acciones</th>',i+="</tr>",i+="</thead>",i+='<tbody class="contenido" id="contenido">',s.forEach((e,s)=>{let o="1"==e.estado?"btn-outline-success":"btn-outline-danger";i+='<tr class="">',i+="<td>"+(parseInt(s)+1)+"</p></td>",i+='<td class="col">'+e.nombre+"</p></td>",i+='<td class="col">'+e.rol+"</p></td>",i+='<td class="col">'+e.unidad+"</p></td>",i+='<td class="col"><a class=" btn btn-rounded '+o+'" onclick="estado('+e.id+","+a+')"  >'+("1"==e.estado?"Activo":"Inactivo")+"</a></p></td>",i+='<td class="col">',i+='<div class="d-flex">',i+=`<a class="btn btn-primary  botonPermiso" id="${a}" onclick="crearModalEditar('${t}','${e.id}')" style="margin:0px 5px">Permisos</a>`,i+='<a class="btn btn-outline-danger  botonPermiso" id="'+a+'" data-bs-toggle="modal" data-bs-target="#exampleModalPermisos'+e.id+'" style="margin:0px 5px"><i class="fa-solid fa-trash fa-xl"></i></a>',i+="<div>",i+="</td>",i+="</tr>"}),i+="</tbody>",i+="</table>",document.getElementById(e.toString()).innerHTML=i,$("#tablaUsuarios").DataTable()}async function waitResponse(e,t="129.5px",a=1){var s="";1==a?(s+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+t+'" width:100% !important;height:50px" id="contenedorWait">',s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+="</div>"):(e.innerHTML="",s+='<td colspan="8" valign="top">',s+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+t+'" id="contenedorWait">',s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+="</div>",s+="</td>"),document.querySelector(e).innerHTML=s}function traerPermisosUser(e,t){return new Promise((a,s)=>{$.ajax({data:{tipo:"permisosUserCarpeta",idUser:t,idSeccion:e},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),a(e)}).fail(e=>{s(e)})})}function findUserById(e){return new Promise((t,a)=>{$.ajax({data:{id:e,tipo:"usuario"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{a(e)})})}async function crearModalEditar(e,t){const a=await findUserById(t);console.log("user",a);const s=await traerPermisosUser(e,t);console.log("permisos",s);let i=["fa-solid fa-eye","fa-solid fa-plus","fa-solid fa-edit","fa-solid fa-eye","fa-solid fa-plus","fa-solid fa-edit","fa-solid fa-folder-tree","fa-solid fa-trash"];var o="";o+='<div class="modal fade" id="exampleModalPermisosUser" tabindex="-1" aria-labelledby="exampleModalPermisosUser" aria-hidden="true">',o+='<div class="modal-dialog">',o+='<div class="modal-content">',o+='<div class="modal-header bg-black">',o+='<h5 class="modal-title text-white">Permisos</h5>',o+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',o+="</div>",o+='<div class="modal-body">',o+='<h3 class="text-black"><strong>'+a.nombre.toUpperCase()+"</strong></h3>",o+='<h5 class="text-black mt-4 mb-1">Permisos de Carpeta <i class="fa-solid fa-folder-open fa-lg" style="margin-left:5px"></i></h5>',o+='<div class="unido_alerta">',o+='<div class="mb-2" style="border:1px solid #bcbcbc;border-radius:5px">',o+='<div class="row p-3">',permisosDefault.forEach((e,t)=>{e.id<4&&(1==e.id?(o+='<div  class="d-flex justify-content-between w-100">',o+='<div class="d-flex '+(1!=e.id?"apagar":"")+'" >',o+='<div  style="width:160px" >',o+=`<i class="${i[t]} fa-xl" style="margin-right:5px"></i>`,o+="<label>"+e.nombre.replaceAll("_"," ")+"</label>",o+="</div>",o+='<input class="form-check-input permiso" id="'+e.id+'" type="checkbox">',o+="</div>",o+='<div class="d-flex apagar" >',o+='<div  style="width:160px" >',o+='<i class="fa-solid fa-right-left fa-xl" style="margin-right:5px"></i>',o+="<label>Heredar Permisos</label>",o+="</div>",o+='<input class="form-check-input" id="heredar" type="checkbox">',o+="</div>",o+="</div>"):(o+='<div class="d-flex '+(1!=e.id?"apagar":"")+'" >',o+='<div  style="width:160px" >',o+=`<i class="${i[t]} fa-xl" style="margin-right:5px"></i>`,o+="<label>"+e.nombre.replaceAll("_"," ")+"</label>",o+="</div>",o+='<input class="form-check-input permiso" id="'+e.id+'" type="checkbox">',o+="</div>"))}),o+="</div>",o+="</div>",o+="</div>",o+='<h5 class="text-black mt-4 mb-1">Permisos de Documento<i class="fa-solid fa-file-pdf fa-lg" style="margin-left:5px"></i></h5>',o+='<div class="unido_alerta">',o+='<div class="mb-2" style="border:1px solid #bcbcbc;border-radius:5px">',o+='<div class="row p-3">',permisosDefault.forEach((e,t)=>{e.id>=4&&(o+='<div class="d-flex '+(4!=e.id?"apagar":"")+'">',o+='<div  style="width:160px">',o+=`<i class="${i[t]} fa-xl" style="margin-right:5px"></i>`,o+="<label>"+e.nombre.replaceAll("_"," ")+"</label>",o+="</div>",o+='<input class="form-check-input permiso" id="'+e.id+'"  type="checkbox">',o+="</div>")}),o+="</div>",o+="</div>",o+="</div>",o+='<div class="w-100"  id="alertasPermisosUser">',o+="</div>",o+="</div>",o+='<div class="modal-footer mt-2 d-flex justify-content-end">',o+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',o+=`<button type="button" class="btn btn-success" onclick="savePermisosUser(${e},${t})"><i class="fa-solid fa-floppy-disk" style="margin-right:3px"></i>Guardar</button>`,o+="</div>",o+="</div>",document.getElementById("modales").innerHTML=o,$("#selectMover").select2({dropdownParent:$("#exampleModalPermisosUser")}),$("#exampleModalPermisosUser").modal("show")}let cont=0;async function savePermisosUser(e,t){let a=document.getElementById("heredar").checked,s=document.querySelectorAll(".permiso");s=Array.apply(null,s);let i=s.filter(e=>e.checked).map(e=>e.id);s.forEach(e=>{if(0==i.includes("1")&&1==e.id){const t=document.createElement("div");return t.classList.add("w-100","p-0","text-start","text-danger","alert"),t.textContent="Ver Carpeta es OBLIGATORIO",e.parentNode.parentNode.parentNode.parentNode.classList.add("alertaPermiso"),void e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t)}});let o=null,n=permisosDefault.filter(e=>1!==e.id||(o=!!i.includes(e.id.toString()),!1)).map(e=>({...e,status:!!i.includes(e.id.toString())||e.status}));if(console.log("permisoId",o),console.log("permisos Array",n),1==o){const s=new FormData;s.append("idSeccion",e),s.append("verSeccion",o),s.append("heredar",a),s.append("idUser",t),s.append("permisos",JSON.stringify(n)),console.log([...s]);let i=URL_BASE+"/permisos/carpeta";const r=await fetch(i,{method:"POST",headers:{token:token},body:s}),l=await r.json();console.log(l),l.exito?Swal.fire({position:"top-end",icon:"success",title:l.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarCarpeta(e)}):l.error?Swal.fire({icon:"error",title:"ERROR",text:l.error}).then(()=>{dibujarCarpeta(e)}):l.exit?Swal.fire({icon:"warning",title:l.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(html+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',l.alertas.error.forEach(e=>{html+='<li class="text-danger"  >',html+=e,html+="</li>"}),html+="</ul>",document.getElementById("alertas").innerHTML=html)}alertas()}document.addEventListener("click",(function(e){document.querySelectorAll(".permiso").forEach(t=>{1==e.target.id&&e.target.classList.contains("permiso")?(t.parentNode.parentNode.parentNode.classList.remove("alertaPermiso"),cont=0,0==e.target.checked&&1!=t.id?(t.checked=!1,console.log("permisi",t.id),t.parentNode.classList.add("apagar"),4==t.id&&t.parentNode.classList.remove("apagar")):1==e.target.checked&&1!=t.id&&t.id<4&&(t.parentNode.classList.toggle("apagar"),t.checked=!1)):4==e.target.id&&e.target.classList.contains("permiso")&&4!=t.id&&t.id>4&&(t.parentNode.classList.toggle("apagar"),t.checked=!1)}),e.target.classList.contains("permiso")&&(e.target.id>1&&1==e.target.checked?cont++:e.target.id>1&&0==e.target.checked&&cont--,console.log("cont1",cont),cont>=1?(document.getElementById("heredar").parentElement.classList.remove("apagar"),document.getElementById("heredar").checked=!1):document.getElementById("heredar").parentElement.classList.add("apagar"))}));