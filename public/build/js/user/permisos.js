const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token")),CARPETA_BASE="/base";let unidades,secciones,roles;async function iniciarApp(){await dibujarCarpetas();let e=generarCarpetas(0,await traerSecciones());const a=document.getElementById("contenedor-carpetas"),t=dibujarArbolCarpetas(e,a);a.append(t)}async function dibujarCarpetas(){document.getElementById("contenedor-titulo").innerHTML='<h1 class="text-black"><strong>Administrar Permisos</strong></h1> <h3 class="text-black mt-3 mb-4">Seleccione una carpeta para elegir los permisos</h3>';const e=document.createElement("div");e.id="contenedor-carpetas",e.classList.add("contenedor-carpetas","mt-4","py-5","px-3");document.getElementById("dibujar-js").appendChild(e)}function traerSecciones(){return new Promise((e,a)=>{let t=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(a=>{a.exit&&Swal.fire({icon:"warning",title:a.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==a.length&&e(t),$.each(a,(s,i)=>{t.push(i),a.length==s+1&&e(t)})}).fail(e=>{a(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp());let permisosDefault=[{id:1,nombre:"Ver_Carpeta",type:"carpeta",descripcion:"Permiso para visualizar la carpeta",status:!1},{id:2,nombre:"Crear_Carpeta",type:"carpeta",descripcion:"Permiso para crear carpetas",status:!1},{id:3,nombre:"Editar_Carpeta",type:"carpeta",descripcion:"Permiso para Editar,Mover,Eliminar la carpeta",status:!1},{id:4,nombre:"Ver_Documento",type:"documento",descripcion:"Permiso para visualizar el documento",status:!1},{id:5,nombre:"Crear_Documento",type:"documento",descripcion:"Permiso para Crear un documento",status:!1},{id:6,nombre:"Editar_Documento",type:"documento",descripcion:"Permiso para Editar la metadata del documento",status:!1},{id:7,nombre:"Mover_Documentos",type:"documento",descripcion:"Permiso para mover de carpeta los documentos",status:!1},{id:8,nombre:"Eliminar_Documento",type:"documento",descripcion:"Permiso para Eliminar el documento",status:!1}];function dibujarArbolCarpetas(e,a){let t=e.nombre[0].toUpperCase()+e.nombre.substring(1);const s=document.createElement("ul");s.style="list-style-type:none;";const i=document.createElement("li");if(i.id="li"+e.id,0==e.hijos.length)i.innerHTML=`\n        <div class="d-flex align-items-center mt-1 mb-2" style="font-size:15px">\n        <div id="carpeta${e.id}">\n        <a class="moverC" style="text-decoration:none ;cursor:pointer" onclick="dibujarCarpeta(${e.id})">\n        <i class="fa-solid fa-folder-open fa-lg" style="margin-right:7px;color:${e.color}"></i>\n        <span style="color:#212529"><strong>${t}</strong></span>\n        </a>\n        </div>\n        </div>\n      `;else{let a;a=0==e.id?'<i class="fa-solid fa-chevron-up  fa-lg"></i>':'<i class="fa-solid fa-chevron-down  fa-lg"></i>',i.innerHTML=`\n        <div class="d-flex align-items-center mt-1 mb-2" style="font-size:15px">\n        <div id="carpeta${e.id}">\n        <a class="moverC"  style="text-decoration:none;cursor:pointer" onclick="dibujarCarpeta(${e.id})">\n        <i class="fa-solid fa-folder-open fa-lg" style="margin-right:7px;color:${e.color}"></i>\n        <span style="color:#212529"><strong>${t}</strong></span>\n        </a>\n          <button class="btn btn-link" type="button" id="boton${e.id}" data-bs-toggle="collapse" data-bs-target="#collapse-${e.id}" style="margin-left:12px" >\n          ${a}\n          </button>\n        </div>\n        </div>\n      `}if(s.appendChild(i),e.hijos.length>0){const a=document.createElement("div");a.id="collapse-"+e.id,0==e.id?a.classList.add("show"):a.classList.add("collapse");const t=document.createElement("ul");t.classList.add("list-group","ms-3","mb-3"),e.hijos.forEach(e=>{const a=dibujarArbolCarpetas(e);t.appendChild(a)}),a.appendChild(t),i.appendChild(a);const s=i.querySelector("#boton"+e.id),o=i.querySelector("#carpeta"+e.id);s.addEventListener("click",()=>{if(s.childNodes[1].classList.contains("fa-chevron-down")){o.classList.add("contenedor-carpetas-permiso","px-3");let e=document.createElement("i");e.classList.add("fa-solid","fa-chevron-up","fa-xl"),s.replaceChild(e,s.childNodes[1])}else if(s.childNodes[1].classList.contains("fa-chevron-up")){o.classList.remove("contenedor-carpetas-permiso","px-3");let e=document.createElement("i");e.classList.add("fa-solid","fa-chevron-down","fa-xl"),s.replaceChild(e,s.childNodes[1])}})}return s}function generarCarpetas(e,a){let t=a.find(a=>a.id==e);if(null==t)var s={nombre:"BASE",id:"0",color:"#212529",hijos:[]};else s={nombre:t.seccion,id:t.id,color:t.color,hijos:[]};return a.filter(a=>a.idPadre==e).forEach(e=>{let t=generarCarpetas(e.id,a);s.hijos.push(t)}),s}function traerSeccion(e){return new Promise((a,t)=>{$.ajax({data:{tipo:"findCarpeta",id:e},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),a(e)}).fail(e=>{t(e)})})}function traerUsers(){return new Promise((e,a)=>{let t=[];$.ajax({data:{tipo:"usuarios"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(a=>{a.exit&&Swal.fire({icon:"warning",title:a.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==a.length&&e(t),$.each(a,(s,i)=>{t.push(i),a.length==s+1&&e(t)})}).fail(e=>{a(e)})})}async function dibujarCarpeta(e){var a="";document.getElementById("contenedor-titulo").innerHTML="";let t=await traerSeccion(e);if(a+='<div class="d-flex justify-content-center padreAtras">',a+='<div class="d-flex justify-content-center hijoAtras">',a+='<a class=" btn btn-outline-danger '+(null==t?"noVisible":"")+' " onclick="dibujarAtras('+padre+')"><i class="fa-solid fa-arrow-left-long fa-2x"></i> <span class="span-boton">Atrás</span></a>',a+="</div>",null==t?a+='<h1 class="text-black mb-3"><strong>Administrar Carpetas</strong></h1>':(a+='<div class="d-flex flex-column justify-content-center">',a+='<div class="d-flex justify-content-center">',a+='<h1 class="text-black mb-3"><i class="fa-solid fa-folder-open fa-xl" style="margin-right:7px;color:'+t.color+'"></i><strong>'+(t.seccion[0].toUpperCase()+t.seccion.substring(1))+"</strong></h1>",a+='<button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" style="margin-left:5px;margin-top:4px;width:25px;height:30px;border-radius:15px">',a+='<i class="fa-solid fa-ellipsis-vertical fa-xl "></i>',a+="</button>",a+='<ul class="dropdown-menu dropdown-menu-dark">',a+=' <li class="puntero"><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exampleModalEditar'+t.id+'"><i class="fa-solid fa-pen-to-square" style="margin-right:7px"></i>Editar</a></li>',a+='<li class="puntero"><a class="dropdown-item" onclick="deleteSeccion('+t.id+')"><i class="fa-solid fa-trash" style="margin-right:7px"></i>Eliminar</a></li>',a+="</ul>",a+="</div>",a+='<h3 class="text-black mt-3 mb-4">Lista de usuarios permitidos para interactuar con la carpeta seleccionada</h3>',a+="</div>"),a+="</div>",a+='<div class="w-100 mt-2">',null!=t){let e=("/base"+t.path).split("/");e.shift();e.forEach(e=>{var t=e.replaceAll("_"," ");console.log("nombre",t),a+='<a class="" style="text-decoration:none!important;color:#969798"><strong>'+(t[0].toUpperCase()+t.substring(1))+"</strong></a> /  "})}a+="</div>",a+='<div class="contenedor-carpetas mt-3 mb-5 py-3 px-4" style="min-width:900px" id="contenedorCarpetas" >',a+="</div>",a+='<div class="modal fade" id="exampleModalEditar'+t.id+'" tabindex="-1" aria-labelledby="exampleModalLabel'+t.id+'" aria-hidden="true">',a+='<div class="modal-dialog">',a+='<div class="modal-content">',a+='  <div class="modal-header bg-black">',a+='   <h5 class="modal-title text-white">Editar</h5>',a+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',a+="  </div>",a+='  <div class="modal-body" style="min-height:350px">',a+='<h3 class="text-black mt-2 mb-4">Edite <strong>'+t.seccion+"</strong></h3>",a+='<div class="mb-4 d-flex justify-content-between">',a+='<div class="d-flex flex-column" style="width:70%">',a+='<label  class="form-label"><strong>Nombre:</strong></label>',a+='<input type="text" class="form-control" id="seccion'+t.id+'" value="'+t.seccion+'">',a+="</div>",a+='<div class="d-flex flex-column" style="width:28%">',a+='<label class="form-label"><strong>Color:</strong></label>',a+='<input type="color" class="form-control  puntero" id="color'+t.id+'" value="'+t.color+'">',a+="</div>",a+="</div>",a+='<div class="mb-4">',a+='<label for="exampleFormControlInput1" class="form-label"><strong>Descripción:</strong></label>',""==t.descripcion?a+='<textarea class="form-control" rows="6" id="descripcion'+t.id+'" placeholder="Esta Sección no tiene descripción"></textarea>':a+='<textarea class="form-control" rows="6" id="descripcion'+t.id+'" >'+t.descripcion+"</textarea>",a+="</div>",a+='<div class="mb-4">',a+='<div class="w-100">',a+='<label class="form-label"><strong>Mover Carpeta:</strong></label>',a+="</div>",a+='<div style="height:30px">',a+='<select style="width:100%;height:100% !important" id="select'+t.id+'" class="js-example-basic-single" >';let s=JSON.parse(t.carpetas);s.unshift({id:"0",idPadre:"0",seccion:"CARPETA BASE",descripcion:"",color:"#000000",path:"/base"}),s.forEach(e=>{e.id!=t.id&&(a+='<optgroup label="'+e.seccion+'">',a+='<option value="'+e.id+'" '+(e.id==t.idPadre?"selected":"")+'><strong><i class="fa-solid fa-folder-open"></i></strong>'+e.path+"</option>",a+="</optgroup>")}),a+="</select>",a+="</div>",a+='<div class="w-100 mt-4" id="alertas'+t.id+'">',a+="</div>",a+="</div>",a+="</div>",a+='<div class="modal-footer">',a+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancelar</button>',a+='<a class="btn btn-success" id="botonCrear" onclick="updateSeccion('+padre+","+t.id+',2)"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",document.getElementById("dibujar-js").innerHTML=a,document.getElementById("dibujar-tabla").innerHTML="",waitResponse("#contenedorCarpetas"),$("#select"+e).select2({dropdownParent:$("#exampleModalEditar"+e)}),await dibujarUsers("contenedorCarpetas",e)}async function dibujarUsers(e,a,t=1,s=[]){0==s.length&&(s=await traerUsers());var i="";i+='<table class="table" style="min-width:900px" id="tablaUsuarios">',i+='<thead class="table-dark">',i+='<tr class="" style="text-transform:uppercase">',i+="<th >N°</th>",i+="<th>Nombre</th>",i+="<th>Rol</th>",i+="<th>Unidad</th>",i+="<th>Estado</th>",i+='<th class="col-1">Acciones</th>',i+="</tr>",i+="</thead>",i+='<tbody class="contenido" id="contenido">',s.forEach((e,s)=>{let o="1"==e.estado?"btn-outline-success":"btn-outline-danger";i+='<tr class="">',i+="<td>"+(parseInt(s)+1)+"</p></td>",i+='<td class="col">'+e.nombre+"</p></td>",i+='<td class="col">'+e.rol+"</p></td>",i+='<td class="col">'+e.unidad+"</p></td>",i+='<td class="col"><a class=" btn btn-rounded '+o+'" onclick="estado('+e.id+","+t+')"  >'+("1"==e.estado?"Activo":"Inactivo")+"</a></p></td>",i+='<td class="col">',i+='<div class="d-flex">',i+=`<a class="btn btn-primary  botonPermiso" id="${t}" onclick="crearModalEditar('${a}','${e.id}')" style="margin:0px 5px">Permisos</a>`,i+='<a class="btn btn-outline-danger  botonPermiso" id="'+t+'" data-bs-toggle="modal" data-bs-target="#exampleModalPermisos'+e.id+'" style="margin:0px 5px"><i class="fa-solid fa-trash fa-xl"></i></a>',i+="<div>",i+="</td>",i+="</tr>"}),i+="</tbody>",i+="</table>",document.getElementById(e.toString()).innerHTML=i,$("#tablaUsuarios").DataTable()}async function waitResponse(e,a="129.5px",t=1){var s="";1==t?(s+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+a+'" width:100% !important;height:50px" id="contenedorWait">',s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+="</div>"):(e.innerHTML="",s+='<td colspan="8" valign="top">',s+='<div class="d-flex justify-content-center align-items-center w-100" style="width:100% !important;height:'+a+'" id="contenedorWait">',s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+=' <div class="spinner-grow" role="status">',s+='<span class="visually-hidden">Loading...</span>',s+="</div>",s+="</div>",s+="</td>"),document.querySelector(e).innerHTML=s}function traerPermisosUser(e,a){return new Promise((t,s)=>{$.ajax({data:{tipo:"permisosUserCarpeta",idUser:a,idSeccion:e},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{s(e)})})}function findUserById(e){return new Promise((a,t)=>{$.ajax({data:{id:e,tipo:"usuario"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),a(e)}).fail(e=>{t(e)})})}async function crearModalEditar(e,a){const t=await findUserById(a);console.log("user",t);const s=await traerPermisosUser(e,a);console.log("permisos",s);let i=["fa-solid fa-eye","fa-solid fa-plus","fa-solid fa-edit","fa-solid fa-eye","fa-solid fa-plus","fa-solid fa-edit","fa-solid fa-folder-tree","fa-solid fa-trash"];var o="";o+='<div class="modal fade" id="exampleModalPermisosUser" tabindex="-1" aria-labelledby="exampleModalPermisosUser" aria-hidden="true">',o+='<div class="modal-dialog">',o+='<div class="modal-content">',o+='<div class="modal-header bg-black">',o+='<h5 class="modal-title text-white">Permisos</h5>',o+='<button type="button" class="btn text-white" style="font-size:11px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',o+="</div>",o+='<div class="modal-body">',o+='<h3 class="text-black"><strong>'+t.nombre.toUpperCase()+"</strong></h3>",o+='<h5 class="text-black mt-4 mb-1">Permisos de Carpeta <i class="fa-solid fa-folder-open fa-lg" style="margin-left:5px"></i></h5>',o+='<div class="mb-2" style="border:1px solid #bcbcbc;border-radius:5px">',o+='<div class="row p-3">',permisosDefault.forEach((e,a)=>{e.id<4&&(o+='<div class="d-flex '+(1!=e.id?"apagar":"")+'" >',o+='<div  style="width:160px" >',o+=`<i class="${i[a]} fa-xl" style="margin-right:5px"></i>`,o+="<label>"+e.nombre.replaceAll("_"," ")+"</label>",o+="</div>",o+='<input class="form-check-input permiso" id="'+e.id+'" type="checkbox">',o+="</div>")}),o+="</div>",o+="</div>",o+='<h5 class="text-black mt-4 mb-1">Permisos de Documento<i class="fa-solid fa-file-pdf fa-lg" style="margin-left:5px"></i></h5>',o+='<div class="mb-2" style="border:1px solid #bcbcbc;border-radius:5px">',o+='<div class="row p-3">',permisosDefault.forEach((e,a)=>{e.id>=4&&(o+='<div class="d-flex '+(4!=e.id?"apagar":"")+'">',o+='<div  style="width:160px">',o+=`<i class="${i[a]} fa-xl" style="margin-right:5px"></i>`,o+="<label>"+e.nombre.replaceAll("_"," ")+"</label>",o+="</div>",o+='<input class="form-check-input permiso" id="'+e.id+'"  type="checkbox">',o+="</div>")}),o+="</div>",o+="</div>",o+='<div class="w-100"  id="alertasMoverDoc">',o+="</div>",o+="</div>",o+='<div class="modal-footer mt-2 d-flex justify-content-end">',o+='<button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',o+=`<button type="button" class="btn btn-success" onclick="savePermisosUser(${e},${a})"><i class="fa-solid fa-floppy-disk" style="margin-right:3px"></i>Guardar</button>`,o+="</div>",o+="</div>",document.getElementById("modales").innerHTML=o,$("#selectMover").select2({dropdownParent:$("#exampleModalPermisosUser")}),$("#exampleModalPermisosUser").modal("show")}async function savePermisosUser(e,a){let t=document.querySelectorAll(".permiso");t=Array.apply(null,t);let s=t.filter(e=>e.checked).map(e=>e.id);if(0==s.includes("1"))return s=t.filter(e=>e.id<4).map(e=>e.id),void t.forEach(e=>{e.id<4&&(console.log("Error","debo lanzar una alerta"),e.checked=!1)});console.log("idPermisos",s);let i=permisosDefault.map(e=>({...e,status:!!s.includes(e.id.toString())||e.status}));console.log("array",i);const o=new FormData;o.append("id",id),o.append("keywords",claves),o.append("data",JSON.stringify(info)),console.log([...o]);const n=await fetch("http://localhost/gdagmcp/documento/update",{method:"POST",headers:{token:token},body:o}),l=await n.json();console.log(l)}document.addEventListener("click",(function(e){document.querySelectorAll(".permiso").forEach(a=>{1==e.target.id&&e.target.classList.contains("permiso")?1!=a.id&&a.id<4&&a.parentNode.classList.toggle("apagar"):4==e.target.id&&e.target.classList.contains("permiso")&&4!=a.id&&a.id>4&&a.parentNode.classList.toggle("apagar")})}));