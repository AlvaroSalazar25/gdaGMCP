const URL_BASE="http://localhost/gdagmcp";let usuarios,unidades,secciones,usuariosSeccion,roles;const user={nombre:"",apellido:"",cedula:"",celular:"",email:"",password:"",idUnidad:"",idRol:""},token=JSON.parse(localStorage.getItem("token"));async function iniciarApp(){usuarios=await traerUsers(),usuariosSeccion=await buscarSeccion(),secciones=await traerSecciones(),unidades=await traerUnidades(),roles=await traerRoles(),await dibujarBotones(),dibujarUsuarios("dibujar-js",1,usuarios),crearModales()}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}async function traerUser(e){let t=JSON.parse(localStorage.getItem("buscarUser")),a=await traerUsers();if(t&&t.length>0){let e=t.map(e=>a.find(t=>t.id===e.id));localStorage.setItem("buscarUser",JSON.stringify(e))}if("1"==e)dibujarUsuarios("dibujar-js",1,a);else if("2"==e){console.log("debe entrar aqui por el tipo 2");const e=JSON.parse(localStorage.getItem("buscarUser"));console.log("user del local antes de dibujar, debo estar solo yo",e),dibujarUsuarios("tablaBuscar",2,e)}}function traerUsers(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"usuarios"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function findUserById(e){return new Promise((t,a)=>{$.ajax({data:{id:e,tipo:"usuario"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{a(e)})})}function traerUnidades(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"unidades"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function traerRoles(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"roles"},url:URL_BASE+"/user/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}function carpetaById(e){return new Promise((t,a)=>{$.ajax({data:{tipo:"findCarpeta",id:e},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),t(e)}).fail(e=>{a(e)})})}function traerSeccionesHijos(e){return new Promise((t,a)=>{let i=[];$.ajax({data:{tipo:"hijos",id:e},url:URL_BASE+"/carpeta/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(i),$.each(e,(a,o)=>{i.push(o),e.length==a+1&&t(i)})}).fail(e=>{a(e)})})}async function dibujarBotones(){document.getElementById("dibujar-botones").innerHTML=' <h1 class="text-black"><strong>Administrar Usuarios</strong></h1> <section> <div class="contenedor-acciones bg-light"> <div class="barra-acciones"> <div class=" contenedor-boton"> <a class="cboton btn btn-warning w-100" onclick="dibujarUsuarios(\'dibujar-js\',1)"><i class="fa-solid fa-users fa-2x"></i> <span class="span-boton">Ver usuarios</span></a> </div> <div class="contenedor-boton"> <a class="cboton btn btn-success w-100" id="crear" onclick="crearUsuario()"><i class="fa-solid fa-user-plus fa-2x"></i> <span class="span-boton">Crear usuarios</span></a> </div> <div class=" contenedor-boton"> <a class="cboton btn btn-primary w-100" onclick="buscarUsuario()"><i class="fa-solid fa-magnifying-glass fa-2x"></i> <span class="span-boton">Buscar usuarios</span></a> </div> </div> </div></section>'}async function dibujarUsuarios(e,t=1,a=[]){console.log("usuarios del dibujar directo del localS",a),0==a.length&&(a=await traerUsers()),console.log("usuarios del dibujar",a);var i="";i+='<table class="table" style="min-width:900px" id="tablaUsuarios">',i+='<thead class="table-dark">',i+='<tr class="" style="text-transform:uppercase">',i+="<th>N°</th>",i+="<th>Nombre</th>",i+="<th>Email</th>",i+="<th>rol</th>",i+="<th>Unidad</th>",i+="<th>Estado</th>",i+="<th>Acciones</th>",i+="</tr>",i+="</thead>",i+='<tbody class="contenido" id="contenido">',a.forEach((e,a)=>{let o="1"==e.estado?"btn-outline-success":"btn-outline-danger";i+='<tr class="">',i+="<td>"+(parseInt(a)+1)+"</p></td>",i+='<td class="col-2">'+e.nombre+"</p></td>",i+='<td class="col-3">'+e.email+"</p></td>",i+='<td class="col-1">'+e.rol+"</p></td>",i+='<td class="col-2">'+e.unidad+"</p></td>",i+='<td class="col-1"><a class=" btn btn-rounded '+o+'" onclick="estado('+e.id+","+t+')"  >'+("1"==e.estado?"Activo":"Inactivo")+"</a></p></td>",i+='<td class="col-2">',i+='<div class="acciones-user">',i+='<a class="btn btn-primary" id="'+t+'" onclick="permisosUser('+e.id+')" style="margin:0px 0px 0px 5px">Permisos</a>',i+='<a class="btn btn-warning " id="'+t+'" onclick="crearUsuario(2,'+e.id+')" style="margin:0px 5px 0px 5px"><i class="fa-regular fa-pen-to-square fa-2x"></i></a>',i+='<a class="btn btn-danger " onclick="eliminarUsuario('+e.id+')"><i class="fa-solid fa-trash fa-2x"></i></a>',i+="</div>",i+="</td>",i+="</tr>"}),i+="</tbody>",i+="</table>",document.getElementById(e.toString()).innerHTML=i,$("#tablaUsuarios").DataTable()}async function permisosUser(e){let t=await findUserById(e);console.log("user",t);var a="";a+='<h1 class="text-black"><strong>Administrar Permisos</strong></h1>',a+='<div class="contenedor-crearUsuario bg-light my-4">',a+='<div class="" style="font-size:15px">',a+='<div class="d-flex">',a+='<p class="text-black"><strong>Usuario:</strong>  '+t.nombre+"</p>",a+='<div class="'+(1==t.estado?"bg-success":"bg-danger")+'" style="width:8px;height:8px;border-radius: 50%;margin-left:3px"></div>',a+="</div>",a+='<p class="text-black"><strong>Rol:</strong>  '+t.rol+"</p>",a+='<p class="text-black"><strong>Unidad:</strong>  '+t.unidad+"</p>",a+='<p class="text-black"><strong>Última Modificación:</strong>  '+t.created_at.split(" ")[0]+" Arrelgar bien la fecha</p>",a+="</div>",a+="</div>",document.getElementById("dibujar-botones").innerHTML="",document.getElementById("dibujar-js").innerHTML=a;document.getElementById("dibujar-tabla").innerHTML='<div class="w-100 d-flex justify-content-end mb-0 mt-2"><div class="d-flex justify-content-around mb-1 mt-2" style="width:260px"><p><strong>CARPETA</strong></p><p><strong>DOCUMENTO</strong></p></div></div><div class="w-100 d-flex justify-content-end mb-3 mt-1"><div class="d-flex justify-content-around" style="width:98px;margin-right:5px"><i class="fa-solid fa-eye fa-xl"></i><i class="fa-solid fa-plus fa-xl"></i><i class="fa-solid fa-edit fa-xl"></i></div><div class="d-flex justify-content-around" style="width:157px"><i class="fa-solid fa-eye fa-xl"></i><i class="fa-solid fa-plus fa-xl"></i><i class="fa-solid fa-edit fa-xl"></i><i class="fa-solid fa-folder-tree fa-xl"></i><i class="fa-solid fa-trash fa-xl"></i></div></div>';let i=dibujarArbolCarpetas(generarCarpetas(0,await traerSecciones()));document.getElementById("dibujar-tabla").appendChild(i)}document.addEventListener("DOMContentLoaded",iniciarApp());let permisosDefault=[{id:1,nombre:"Ver_Carpeta",type:"carpeta",descripcion:"Permiso para visualizar la carpeta",status:!1},{id:2,nombre:"Crear_Carpeta",type:"carpeta",descripcion:"Permiso para crear carpetas",status:!1},{id:3,nombre:"Editar_Carpeta",type:"carpeta",descripcion:"Permiso para Editar,Mover,Eliminar la carpeta",status:!1},{id:4,nombre:"Ver_Documento",type:"documento",descripcion:"Permiso para visualizar el documento",status:!1},{id:5,nombre:"Crear_Documento",type:"documento",descripcion:"Permiso para Crear un documento",status:!1},{id:6,nombre:"Editar_Documento",type:"documento",descripcion:"Permiso para Editar la metadata del documento",status:!1},{id:7,nombre:"Mover_Documentos",type:"documento",descripcion:"Permiso para mover de carpeta los documentos",status:!1},{id:8,nombre:"Eliminar_Documento",type:"documento",descripcion:"Permiso para Eliminar el documento",status:!1}];function traerSeccionesCheck(e){var t=[],a=secciones.filter(t=>t.idPadre==e);return null!=a&&a.forEach(e=>{t.push(e.id),t=t.concat(traerSeccionesCheck(e.id))}),t}function dibujarArbolCarpetas(e){const t=document.createElement("ul");t.style="font-size:15px";const a=document.createElement("li"),i=document.createElement("div");i.classList.add("w-100","d-flex","justify-content-between");const o=document.createElement("p");o.textContent=e.nombre,0==e.id&&(i.classList.add("bg-black"),o.style="color:white;font-weight:bold"),e.hijos.length>0?i.style="border-bottom:1px dashed #707071;background-color:#DEE2E6":i.style="border-bottom:1px dashed #707071 !important",a.appendChild(i),i.appendChild(o);const n=document.createElement("div");n.classList.add("d-flex");var s=document.createElement("div");s.style="padding: 0px 3px;border-right:1px solid;border-left:1px solid;margin-right:5px";var r=document.createElement("div");return r.style="padding: 2px 3px;border-right:1px solid",permisosDefault.forEach(t=>{const a=document.createElement("input");a.classList.add("form-check-input",""+t.nombre,""+e.id),a.style="margin:5px;border:1px solid #1a1b15",a.type="checkbox",a.id=e.id+"p"+t.id,"carpeta"==t.type?s.appendChild(a):r.appendChild(a)}),n.appendChild(s),n.appendChild(r),i.appendChild(n),t.appendChild(a),e.hijos.length>0&&e.hijos.forEach(e=>{const t=dibujarArbolCarpetas(e);a.appendChild(t)}),t}function generarCarpetas(e,t){let a=t.find(t=>t.id==e);if(null==a)var i={nombre:"MARQUE PARA SELECCIONAR TODOS",id:"0",hijos:[]};else i={nombre:a.seccion,id:a.id,hijos:[]};return t.filter(t=>t.idPadre==e).forEach(e=>{let a=generarCarpetas(e.id,t);i.hijos.push(a)}),i}async function crearModales(e=1){let t=await buscarSeccion();var a="";t.forEach(t=>{let i=JSON.parse(t.seccion);console.log("permiso de cada user",i),a+='<div class="modal fade" id="exampleModalPermisos'+t.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',a+='<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">',a+=' <div class="modal-content">',a+=' <div class="modal-header">',a+=' <h5 class="modal-title" id="exampleModalLabel">EDITAR PERMISOS DE <strong>'+t.nombre.toUpperCase()+"</strong></h5>",a+='  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>',a+=" </div>",a+=' <div class="modal-body">',secciones.forEach(e=>{let o=i.find(t=>t.id==e.id);if(a+='<div class="d-flex justify-content-between" style="font-size:17px" >',null!=o){let i=JSON.parse(o.permisos);a+="<div>",a+='<input class="secciones" type="checkbox" checked id="'+e.id+t.id+'" name="'+e.seccion+'" value="'+e.id+'">',a+=' <label for="'+e.seccion+'">'+e.seccion+"</label>",a+="</div>",a+='<div class="d-flex col-6 justify-content-center" id="contenedor'+e.id+t.id+'" style="font-size:13px">',i.forEach(e=>{"true"==e.status?(a+='<input style="margin-right:5px" type="checkbox" checked id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',a+=' <label style="margin-right:10px ">'+e.nombre+"</label>"):(a+='<input style="margin-right:5px" type="checkbox" id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',a+=' <label style="margin-right:10px ">'+e.nombre+"</label>")}),a+="</div>"}else a+="<div>",a+='<input class="secciones" type="checkbox" id="'+e.id+t.id+'" name="'+e.seccion+'" value="'+e.id+'">',a+=' <label for="'+e.seccion+'">'+e.seccion+"</label>",a+="</div>",a+='<div class="d-flex col-6 justify-content-center visiblePermiso" id="contenedor'+e.id+t.id+'" style="font-size:13px">',permisosDefault.forEach(e=>{a+='<input style="margin-right:5px" type="checkbox"  id="permiso'+e.id+'" name="'+e.nombre+'" value="'+e.id+'">',a+=' <label style="margin-right:10px" >'+e.nombre+"</label>"}),a+="</div>";a+="</div>"}),a+=" </div>",a+='<div class="mx-3" id="alertaError'+t.id+'">',a+="</div>",a+='<div class="modal-footer ">',a+='<div class="d-flex justify-content-between w-100">',t.permisosWhere?a+='<div class="form-text" id="seccionHelp">* Este usuario tiene los permisos de <strong>'+t.permisosWhere+"</strong></div>":a+='<div class="form-text" id="seccionHelp"><strong>* Permisos personalizados</strong></div>',a+="<div>",a+=' <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>',a+=' <button type="button" class="btn btn-success" onclick="guardarPermisos('+t.id+","+e+')">Guardar cambios</button>',a+="</div>",a+="</div>",a+="</div>",a+="</div>",a+=" </div>",a+="</div>",a+=" </div>",a+="</div>",document.getElementById("modales").innerHTML=a})}async function guardarPermisos(e,t=1){let a=document.querySelector(".botonPermiso").id,i=[];secciones.forEach(t=>{let a=document.getElementById(t.id+e);1==a.checked&&i.push({id:a.id,value:a.value,seccion:a.name})}),console.log("deben estar las secciones del usuario",i);let o=[];var n=[];if(i.forEach(e=>{let t=document.getElementById("contenedor"+e.id),a=[];var i=0;for(let o=0;o<t.children.length;o++)if(1==t.children[o].checked)null!=t.children[o].value&&a.push({id:t.children[o].value,nombre:t.children[o].name,status:"true"});else if(null!=t.children[o].value){if(2==++i){let t="No se a seleccionado permisos para la sección de "+e.seccion;n.push(t)}a.push({id:t.children[o].value,nombre:t.children[o].name,status:"false"})}o.push({idSeccion:e,idPermisos:a})}),console.log(n),0!=n.length){let t="";return t+='<ul class="alert bg-white px-5" style="border-radius:5px;border:1px solid red"  style="width:100%" >',n.forEach(e=>{t+='<li class="text-danger"  >',t+=e,t+="</li>"}),t+="</ul>",console.log(document.getElementById("alertaError")),document.getElementById("alertaError"+e).innerHTML=t,void alertas()}{$("#exampleModalPermisos"+e).modal("hide"),console.log("a ver",o);const t=new FormData;t.append("id",e),t.append("permisos",JSON.stringify(o)),console.log([...t]);let i=URL_BASE+"/user/permisos/save";const n=await fetch(i,{method:"POST",headers:{token:token},body:t}),r=await n.json();var s="";console.log(r),r.exito?Swal.fire({position:"top-end",icon:"success",title:r.exito,showConfirmButton:!1,timer:1500}).then(()=>{traerUser(a),document.getElementById("modales").innerHTML="",crearModales()}):r.error?Swal.fire({icon:"error",title:"ERROR",text:r.error}).then(()=>{traerUser(a),document.getElementById("modales").innerHTML="",crearModales()}):r.exit?Swal.fire({icon:"warning",title:r.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(s+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',r.alertas.error.forEach(e=>{s+='<li class="text-danger"  >',s+=e,s+="</li>"}),s+="</ul>",document.getElementById("alertas").innerHTML=s),alertas()}}document.addEventListener("click",(function(e){permisosDefault.forEach(t=>{if(e.target.classList.contains(""+t.nombre)){let i=[];var a=e.target.id.split("p")[0];console.log("id",a),console.log(e.target.checked),i=traerSeccionesCheck(a);let o=secciones.find(e=>e.id==a);if(null!=o){let e=o.idPadre;for(;"0"!=e;){let t=secciones.find(t=>t.id==e);e=t.idPadre,i.push(t.id)}}console.log("hijos",i),i.forEach(e=>{var a=document.getElementById(`${e}p${t.id}`);a.checked,a.checked=!0})}})})),document.addEventListener("click",(function(e){if(e.target.classList.contains("secciones")){let t=e.target,a=document.getElementById("contenedor"+t.id);if(console.log(a),1==t.checked)a.classList.toggle("visiblePermiso"),[].push(t.value);else{a.classList.toggle("visiblePermiso");for(let e=0;e<a.children.length;e++)a.children[e].checked=!1}}}));let datos={nombre:"",apellido:"",cedula:"",celular:"",email:"",unidad:"",rol:""};function crearUsuario(e=1,t){if(console.log("tipoooooo",e),2==e){var a=usuariosSeccion.find(e=>e.id==t);console.log(a);var i=a.nombre.split(" ")[0],o=a.nombre.split(" ")[1],n=a.cedula,s=a.email,r=a.celular,l=a.idUnidad;console.log(l);var d=a.idRol}i||o||n||s||r||l||d||(i="",o="",n="",s="",r="",l="",d="");var c="";c+='<div class="contenedor-crearUsuario bg-light ">',2==e?(c+='<h3 class="text-black mt-2 mb-4">Editar datos de '+i+" "+o+"</h3>",c+=' <input type="hidden" id="idUser" name="id" value="'+a.id+'" placeholder="" required>'):c+='<h3 class="text-black mt-2 mb-4">Ingrese los datos del nuevo usuario</h3>',c+="<form>",c+='<div class="d-flex justify-content-between">',c+='<div class="mb-3 col-md-6" style="padding-right:5px">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Nombre:</strong></label>',c+=' <input type="text" class="form-control" id="nombre" name="nombre" value="'+i+'" placeholder="" required>',c+="</div>",c+='<div class="mb-3 col-md-6" style="padding-left:5px">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Apellido:</strong></label>',c+='<input type="text" class="form-control" id="apellido" name="apellido" value="'+o+'" placeholder="" required>',c+="</div>",c+="</div>",c+='<div class="mb-3">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Cédula:</strong></label>',c+='<input type="number" class="form-control" id="cedula" name="cedula" value="'+n+'" placeholder="1600XXXXXX" aria-label="Username" aria-describedby="basic-addon1">',c+="</div>",c+='<div class="mb-3">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Celular:</strong></label>',c+='<input type="number" class="form-control" id="celular" value="'+r+'" name="celular" placeholder="098XXXXXXX" aria-label="Username" aria-describedby="basic-addon1">',c+="</div>",c+='<div class="mb-3">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Email:</strong></label>',c+='<div class="input-group mb-3">',c+='<span class="input-group-text" id="basic-addon1">@</span>',c+='<input type="text" class="form-control" placeholder="" value="'+s+'" id="email" name="email">',c+="</div>",c+="</div>",c+='<div class="mb-3">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Unidad:</strong></label>',c+='<select class="form-select" name="unidad" id="unidad">',c+='<option  value="" selected disabled> --  Seleccione una opción --</option>',unidades.forEach(e=>{e.id==l?c+='<option value="'+e.id+'" selected>'+e.unidad+" ("+e.jefe+")</option>":c+='<option value="'+e.id+'">'+e.unidad+" ("+e.jefe+")</option>"}),c+="</select>",c+="</div>",c+='<div class="mb-3">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Rol:</strong></label>',c+='<select class="form-select" name="rol" id="rol">',c+='<option value="" selected disabled> --  Seleccione una opción --</option>',roles.forEach(e=>{e.id==d?c+='<option value="'+e.id+'" selected>'+e.rol+"</option>":c+='<option value="'+e.id+'">'+e.rol+"</option>"}),c+="</select>",c+="</div>",1==e&&(c+='<div class="d-flex ">',c+='<div class="mb-1 col-md-10" style="padding-right:5px">',c+='<label for="exampleFormControlInput1" class="form-label"><strong>Contraseña:</strong></label>',c+='<input type="password" id="password" name="password" class="form-control noallow" placeholder="" disabled>',c+="</div>",c+='<div class="mb-1 col d-flex justify-content-start align-items-end" >',c+='<buttom type="buttom" class="btn btn-warning w-100" id="btnBlock" onclick="llenarPass()">Cambiar contraseña</buttom>',c+="</div>",c+="</div>",c+='<div id="passwordHelp" class="form-text">Si deja en blanco la contraseña será la cédula del nuevo usuario.</div>'),c+='<div class="w-100 mt-2" id="alertas">',c+="</div>",c+='<div class="my-5 d-flex justify-content-center align-items-center">',c+='<a class="btn btn-success px-5 py-2" id="botonCrear" style="font-size:15px" onclick="guardarDatos('+e+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',c+="</div>",c+="</div>",c+="</form>",document.getElementById("dibujar-js").innerHTML=c}async function eliminarUsuario(e){const t=usuarios.find(t=>t.id==e);Swal.fire({title:"ELIMINAR",text:`Eliminar de forma permamente a ${t.nombre}?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",confirmButtonColor:"#dc3545"}).then(t=>{t.isConfirmed&&$.ajax({data:{id:e},url:URL_BASE+"/user/delete",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exito?Swal.fire({position:"top-end",icon:"success",title:e.exito,showConfirmButton:!1,timer:1500}).then(()=>{window.location.href=URL_BASE+"/admin"}):e.error?(Swal.fire("ERROR","error",e.error),crearUsuario()):e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"})}).fail(e=>{console.log(e)})})}function llenarPass(){document.getElementById("btnBlock").addEventListener("click",liberarBoton())}function liberarBoton(){const e=document.getElementById("password");1==e.disabled?(e.disabled=!1,e.classList.remove("noallow")):(e.disabled=!0,e.classList.add("noallow"))}async function guardarDatos(e){let t,{nombre:a,apellido:i,cedula:o,celular:n,email:s,password:r,idUnidad:l,idRol:d}=user;a=document.getElementById("nombre").value,i=document.getElementById("apellido").value,o=document.getElementById("cedula").value,n=document.getElementById("celular").value,s=document.getElementById("email").value,1==e&&(r=document.getElementById("password").value,1==document.getElementById("password").disabled&&(r=document.getElementById("cedula").value)),l=document.getElementById("unidad").value,d=document.getElementById("rol").value,t=i.length>0?a+" "+i:a;const c=new FormData;if(2==e){let e=document.getElementById("idUser").value;c.append("id",e)}let u;c.append("nombre",t),c.append("apellido",i),c.append("cedula",o),c.append("celular",n),c.append("email",s),1==e&&(o==r?c.append("passwordCedula",1):c.append("passwordCedula",0),c.append("password",r)),c.append("idUnidad",l),c.append("idRol",d),1==e?u=URL_BASE+"/user/create":2==e&&(u=URL_BASE+"/user/update");const m=await fetch(u,{method:"POST",headers:{token:token},body:c}),p=await m.json();var b="";p.exito?Swal.fire({position:"top-end",icon:"success",title:p.exito,showConfirmButton:!1,timer:1500}).then(()=>{window.location.href=URL_BASE+"/admin"}):p.error?Swal.fire({icon:"error",title:"ERROR",text:p.error}).then(()=>{crearUsuario()}):p.exit?Swal.fire({icon:"warning",title:p.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(b+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',p.alertas.error.forEach(e=>{b+='<li class="text-danger"  >',b+=e,b+="</li>"}),b+="</ul>",document.getElementById("alertas").innerHTML=b),alertas()}function estado(e,t=1){$.ajax({data:{id:e},url:URL_BASE+"/user/estado",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.activo?Swal.fire({position:"top-end",icon:"success",title:e.activo,showConfirmButton:!1,timer:1500}).then(()=>{console.log("activo"),console.log("tipo",t),traerUser(t)}):e.inactivo?Swal.fire({position:"top-end",icon:"error",title:e.inactivo,showConfirmButton:!1,timer:1500}).then(()=>{console.log("activo"),console.log("tipo",t),traerUser(t)}):e.exit?Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):Swal.fire({icon:"error",title:"ERROR",text:e.error}).then(()=>{traerUser(t)})}).fail(e=>{console.log(e)})}function buscarUsuario(){document.getElementById("dibujar-js").innerHTML='<div class="contenedor-crearUsuario bg-light mb-4"><h3 class="text-black">Ingrese los datos para buscar al usuario</h3><div class="mb-3"><label for="exampleFormControlInput1" class="form-label"><strong>Buscar por:</strong></label><select class="form-select selectDocumentos" name="tipo" id="tipo" onchange="elegirTipo()"><option value="" selected disabled> --  Seleccione una opción -- </option><option value="1">Nombre</option><option value="2">Rol</option><option value="3">Unidad</option></select></div><div id="elegir"></div></div><div id="tablaBuscar"></div></div>'}function elegirTipo(){let e=document.getElementById("tipo").value;var t="";if(e)switch(e){case"1":t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Ingrese el nombre:</strong></label>',t+='<input type="text" class="form-control buscar" placeholder="" aria-label="Username" aria-describedby="basic-addon1" onKeyUp="escucharNombre(this.value)">',t+="</div>",document.getElementById("elegir").innerHTML=t,document.getElementById("tablaBuscar").innerHTML="";break;case"2":t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Buscar por rol:</strong></label>',t+='<select class="form-select" name="rol" id="rol" onchange="escucharRol()">',t+='<option value="" selected disabled> --  Seleccione una opción --</option>',roles.forEach(e=>{t+='<option value="'+e.id+'">'+e.rol+"</option>"}),t+="</select>",t+="</div>",document.getElementById("elegir").innerHTML=t,document.getElementById("tablaBuscar").innerHTML="";break;case"3":t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Buscar por Unidad:</strong></label>',t+='<select class="form-select" name="unidad" id="unidad" onchange="escucharUnidad()">',t+='<option value="" selected disabled> --  Seleccione una opción --</option>',unidades.forEach(e=>{t+='<option value="'+e.id+'">'+e.unidad+"</option>"}),t+="</select>",t+="</div>",document.getElementById("elegir").innerHTML=t,document.getElementById("tablaBuscar").innerHTML=""}}function buscarSeccion(){return new Promise((e,t)=>{let a=[];$.ajax({url:URL_BASE+"/user/seccion",type:"GET",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),$.each(t,(i,o)=>{a.push(o),t.length==i+1&&e(a)})}).fail(e=>{t(e)})})}escucharNombre=e=>{$.ajax({data:{tipo:"buscarNombre",dato:e},url:URL_BASE+"/user/buscar",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{var a="";if(0!=e.length){if(t.error)return a+="<div class='w-100 d-flex justify-content-center align-items-center' style='height:200px'> <div class='bg-danger d-flex justify-content-center align-items-center w-100' style='border-radius:5px;height:40px'><h4 class='card-title text-white' style='text-transform: uppercase'>No existen coincidencias</h4></div></div>",void(document.getElementById("tablaBuscar").innerHTML=a);t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),localStorage.setItem("buscarUser",JSON.stringify(t)),dibujarUsuarios("tablaBuscar",2,t)}else document.getElementById("tablaBuscar").innerHTML=""}).fail(e=>{console.log(e)})},escucharRol=()=>{let e=document.getElementById("rol").value;$.ajax({data:{tipo:"buscarRol",dato:e},url:URL_BASE+"/user/buscar",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{var t="";if(e.error)return t+="<div class='w-100 d-flex justify-content-center align-items-center' style='height:200px'> <div class='bg-danger d-flex justify-content-center align-items-center w-100' style='border-radius:5px;height:40px'><h4 class='card-title text-white' style='text-transform: uppercase'>No existen coincidencias</h4></div></div>",void(document.getElementById("tablaBuscar").innerHTML=t);e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),localStorage.setItem("buscarUser",JSON.stringify(e)),dibujarUsuarios("tablaBuscar",2,e)}).fail(e=>{console.log(e)})},escucharUnidad=()=>{let e=document.getElementById("unidad").value;$.ajax({data:{tipo:"buscarUnidad",dato:e},url:URL_BASE+"/user/buscar",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{var t="";if(e.error)return t+="<div class='w-100 d-flex justify-content-center align-items-center' style='height:200px'> <div class='bg-danger d-flex justify-content-center align-items-center w-100' style='border-radius:5px;height:40px'><h4 class='card-title text-white' style='text-transform: uppercase'>No existen coincidencias</h4></div></div>",void(document.getElementById("tablaBuscar").innerHTML=t);e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),localStorage.setItem("buscarUser",JSON.stringify(e)),dibujarUsuarios("tablaBuscar",2,e)}).fail(e=>{console.log(e)})};