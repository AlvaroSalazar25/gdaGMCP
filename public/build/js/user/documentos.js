const URL_BASE="http://localhost/gdagmcp",token=JSON.parse(localStorage.getItem("token"));let unidades,secciones,roles;async function iniciarApp(){secciones=await traerSecciones(),dibujarDocumentos()}function alertas(){const e=document.querySelectorAll(".alert"),t=document.getElementById("alertas"),a=document.querySelector("#alertaTipo");e&&setTimeout(()=>{e.forEach((function(e){e.remove(),t&&(t.innerHTML=""),a&&(a.innerHTML="")}))},3e3)}function traerSecciones(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"seccion"},url:URL_BASE+"/documentos/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(o,s)=>{a.push(s),t.length==o+1&&e(a)})}).fail(e=>{t(e)})})}function traerUltimosDocs(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"5docs"},url:URL_BASE+"/documentos/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(o,s)=>{a.push(s),t.length==o+1&&e(a)})}).fail(e=>{t(e)})})}function traerSeccionesFormulario(){return new Promise((e,t)=>{let a=[];$.ajax({data:{tipo:"formularios"},url:URL_BASE+"/documentos/datos",type:"POST",headers:{token:token},dataType:"json"}).done(t=>{t.exit&&Swal.fire({icon:"warning",title:t.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==t.length&&e(a),$.each(t,(o,s)=>{a.push(s),t.length==o+1&&e(a)})}).fail(e=>{t(e)})})}async function dibujarDocumentos(){let e=await traerSecciones(),t=await traerUltimosDocs();var a="";document.getElementById("dibujar-tabla").innerHTML="",a+='<h1 class="text-black mb-3"><strong>Administrar Documentos</strong></h1>',a+='<div class="mb-3">',a+='<div class="d-flex justify-content-end">',a+='<a class=" btn btn-primary " onclick="agregarDocumento(1)"><i class="fa-solid fa-plus fa-2x"></i> <span class="span-boton">Agregar Documento</span></a>',a+="</div>",a+="</div>",a+='<div class="contenedor-crearUsuario bg-light ">',a+='<h3 class="text-black mt-2 mb-4">Seleccione la Sección para buscar los documentos</h3>',a+='<select class="form-select selectDocumentos" name="seccion" id="seccion" onchange="elegirSeccion()">',a+='<option value="" selected disabled> -- Seleccione una Sección -- </option>',e.forEach(e=>{a+='<option value="'+e.id+'">'+e.seccion+"</option>"}),a+='</select">',a+='</div">',document.getElementById("dibujar-js").innerHTML=a;var o="";o+='<h3 class="mb-3 mt-5 text-black">Archivos agregados recientemente</h3>',o+='<table class="table" style="min-width:1000px" id="tablaDocsUltimo">',o+='<thead class="table-dark">',o+='<tr class="" style="text-transform:uppercase">',o+="<th>N°</th>",o+='<th class="">Seccion</th>',o+='<th class="">Formulario</th>',o+='<th class="">Responsable</th>',o+='<th class="">Datos</th>',o+='<th class="">Fecha</th>',o+='<th class="">Estado</th>',o+='<th class="">Archivo</th>',o+="</tr>",o+="</thead>",o+='<tbody class="contenido" id="contenido">',console.log(t),t.forEach((e,t)=>{o+="<tr>",o+="<td>"+(parseInt(t)+1)+"</td>",o+="<td>"+e.seccion+"</td>",o+="<td>"+e.formulario+"</td>",o+="<td>"+e.responsable+"</td>",o+='<td><buttom class="btn btn-secondary" style="margin-left:12px" data-bs-toggle="modal" data-bs-target="#exampleModalVer'+e.id+'">Ver</buttom></td>',o+="<td>"+e.created_at.split(" ")[0]+"</td>",o+="<td>",0==e.status?o+='<span class="badge badge-pill bg-danger" style="margin-left:15px"><i class="fa-solid fa-circle-exclamation fa-lg"></i></span>':o+='<span class="badge badge-pill bg-success" style="margin-left:15px"><i class="fa-solid fa-circle-check fa-lg"></i></span>',o+="</td>",o+="<td>";const a="'"+e.path+"'",s="'"+e.codigo+"'";o+='<buttom title="Ver Documento" class="btn btn-outline-primary" style="margin-right:5px" onclick="abrirPdf('+a+","+s+')"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',o+='<buttom title="Descargar Documento" class="btn btn-primary"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',o+="</td>",o+="</tr>",o+='<div class="modal fade" id="exampleModalVer'+e.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',o+=' <div class="modal-dialog modal-dialog-centered">',o+=' <div class="modal-content">',o+=' <div class="modal-header bg-black ">',o+=' <h5 class="modal-title text-white" id="exampleModalLabel">Metadatos del Documento <strong>'+e.codigo+"</strong></h5>",o+='<button type="button" class="btn text-white" style="font-size:13px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',o+=" </div>",o+='  <div class="modal-body">';let l=JSON.parse(e.keywords),n=JSON.parse(e.data);o+="<p><strong>KEYWORDS</strong></p>",o+="<p>"+l.keywords+"</p>",console.log("datos",n),n.forEach(e=>{o+="<p><strong>"+e.nombre.toUpperCase()+"</strong></p>",o+="<p>"+e.valor+"</p>"}),o+="  </div>",o+=' <div class="modal-footer">',o+=' <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',o+="  </div>",o+="</div>",o+="</div>",o+="</div>"}),o+="</tbody>",o+="</table>",o+="</tbody>",document.getElementById("dibujar-tabla").innerHTML=o,$("#tablaDocsUltimo").DataTable()}async function agregarDocumento(){let e=await traerSecciones();var t="";document.getElementById("dibujar-tabla").innerHTML="",t+='<h1 class="text-black mb-3"><strong>Administrar Documentos</strong></h1>',t+='<div class="mb-3">',t+='<div class="d-flex justify-content-end">',t+='<a class=" btn btn-outline-danger " onclick="dibujarDocumentos(1)"><i class="fa-solid fa-arrow-left fa-2x"></i> <span class="span-boton">Regresar</span></a>',t+="</div>",t+="</div>",t+='<div class="contenedor-crearUsuario bg-light ">',t+='<h3 class="text-black mt-2 mb-4">Elija la Sección para ingresar el nuevo documento</h3>',t+="<form>",t+='<div class="mb-3">',t+='<label for="exampleFormControlInput1" class="form-label"><strong>Seccion:</strong></label>',t+='<select class="form-select w-100" style="height:30px" id="seccion" onchange="elegirSeccionAgregar()">',t+=' <option value="" selected disabled> -- Seleccione una sección -- </option>',e.forEach(e=>{t+=' <option value="'+e.id+'">'+e.seccion+"</option>"}),t+="</select>",t+="</div>",t+="</form>",t+="</div>",t+="</div>",document.getElementById("dibujar-js").innerHTML=t}async function elegirSeccionAgregar(){var e="";let t=document.getElementById("seccion").value,a=(await traerSeccionesFormulario(t)).find(e=>e.id==t);if("1"==a.idFormulario)document.getElementById("dibujar-tabla").innerHTML="",e+='<div class="alert bg-danger px-5 py-2 mt-3 w-100" style="border-radius:5px;border:1px solid red">',e+='<div class="d-flex justify-content-center align-items-center">',e+='<h4 class="text-white">No Existe Formulario adjunto</h4>',e+="</div>",e+="</div>",document.getElementById("dibujar-tabla").innerHTML=e;else{document.getElementById("dibujar-tabla").innerHTML="",e+='<div class="contenedor-crearUsuario bg-light ">',e+='<h3 class="text-black mt-2 mb-4">Ingrese los datos del documento</h3>',e+="<form>";let o=JSON.parse(a.campos),s=JSON.parse(a.keywords),l=JSON.parse(a.archivo).map(e=>"."+e);e+='<div class="row">',e+='<div class="mb-3 w-100" id="'+s.input+'" >',e+='<label class="form-label"><strong>Ingrese '+s.input+":</strong></label>",e+='<input type="'+s.type+'" class="form-control datos"  name="'+s.input+'" value="" placeholder="Agregue palabras clave del documento">',e+="</div>",o.forEach(t=>{const{input:a,type:o}=t;e+='<div class="mb-3 w-100" id="'+a+'">',e+='<label class="form-label"><strong>Ingrese '+a[0].toUpperCase()+a.substring(1)+":</strong></label>",e+="text"==o?'<textarea class="w-100 form-control datos" name="'+a+'" rows="5"></textarea>':' <input type="'+o+'" class="form-control datos"  name="'+a+'">',e+="</div>"}),e+="</div>",e+='<div class="mb-3 w-100" id="archivo">',e+='<label class="form-label"><strong>Cargar el archivo:</strong></label>',e+=' <input type="file" class="form-control datos" name="archivo" accept="'+l+'">',e+="</div>",e+='<div class="w-100 mt-2" id="alertas">',e+="</div>",e+='<div class="my-5 d-flex justify-content-center align-items-center">',e+='<a class="btn btn-success px-5 py-2" id="botonCrear" style="font-size:15px" onclick="saveArchivo('+a.idFormulario+","+t+')"><i class="fa-solid fa-floppy-disk"></i> <span style="margin-left:8px">Guardar</span></a>',e+="</div>",e+="</form>",document.getElementById("dibujar-tabla").innerHTML=e}}async function saveArchivo(e=1,t=1){const a=document.querySelectorAll(".datos"),o=Array.apply(null,a),s=[];let l,n;if(o.forEach(e=>{let t=e.name,a=e.value;if(""==e.value){e.classList.add("errorInput");const a=document.createElement("div");a.id="divAlerta"+t,a.textContent="El campo "+t+" es OBLIGATORIO",a.style.color="red";let o=document.getElementById(t);document.getElementById("divAlerta"+t)||o.appendChild(a)}else{e.classList.remove("errorInput");const o=document.getElementById("divAlerta"+t);o&&(o.innerHTML=""),"keywords"==t?l={keywords:a}:"archivo"==t?(console.log("nombreInput",e),n=e.files[0]):s.push({nombre:t,valor:a})}}),s.length==o.length-2){const a=new FormData;a.append("idSeccion",t),a.append("idFormulario",e),a.append("keywords",JSON.stringify(l)),a.append("path",n),a.append("data",JSON.stringify(s)),console.log([...a]);let o=URL_BASE+"/documentos/create";const i=await fetch(o,{method:"POST",headers:{token:token},body:a}),r=await i.json();console.log(r),r.exito?Swal.fire({position:"top-end",icon:"success",title:r.exito,showConfirmButton:!1,timer:1500}).then(()=>{dibujarDocumentos()}):r.archivo?Swal.fire({icon:"error",title:"ERROR",text:r.archivo}):r.exit?Swal.fire({icon:"warning",title:r.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}):(html+='<ul class="alert bg-white px-5 mt-3" style="border-radius:5px;border:1px solid red"  style="width:100%" >',r.alertas.error.forEach(e=>{html+='<li class="text-danger"  >',html+=e,html+="</li>"}),html+="</ul>",document.getElementById("alertas").innerHTML=html),alertas()}}async function elegirSeccion(){var e="";let t=document.getElementById("seccion").value,a=await traerDocs(t);0==a?(document.getElementById("dibujar-tabla").innerHTML="",e+='<div class="alert bg-danger px-5 py-2 mt-3 w-100" style="border-radius:5px;border:1px solid red">',e+='<div class="d-flex justify-content-center align-items-center">',e+='<h4 class="text-white">No Existen Documentos</h4>',e+="</div>",e+="</div>",document.getElementById("dibujar-tabla").innerHTML=e):(e+='<table class="table" style="min-width:1100px" id="tablaDocs">',e+='<thead class="table-dark">',e+='<tr class="" style="text-transform:uppercase">',e+="<th>N°</th>",e+='<th class="">Seccion</th>',e+='<th class="">Formulario</th>',e+='<th class="">Responsable</th>',e+='<th class="">Datos</th>',e+='<th class="">Fecha</th>',e+='<th class="">Estado</th>',e+='<th class="">Archivo</th>',e+="</tr>",e+="</thead>",e+='<tbody class="contenido" id="contenido">',a.forEach((t,a)=>{e+="<tr>",e+="<td>"+(parseInt(a)+1)+"</td>",e+="<td>"+t.seccion+"</td>",e+="<td>"+t.formulario+"</td>",e+="<td>"+t.responsable+"</td>",e+='<td><buttom class="btn btn-secondary" style="margin-left:12px" data-bs-toggle="modal" data-bs-target="#exampleModalVer'+t.id+'">Ver</buttom></td>',e+="<td>"+t.created_at.split(" ")[0]+"</td>",e+="<td>",0==t.status?e+='<span class="badge badge-pill bg-danger" style="margin-left:15px"><i class="fa-solid fa-circle-exclamation fa-lg"></i></span>':e+='<span class="badge badge-pill bg-success" style="margin-left:15px"><i class="fa-solid fa-circle-check fa-lg"></i></span>',e+="</td>",e+="<td>";const o="'"+t.path+"'",s="'"+t.codigo+"'";e+='<buttom title="Ver Documento" class="btn btn-outline-primary" style="margin-right:5px" onclick="abrirPdf('+o+","+s+')"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',e+='<buttom title="Descargar Documento" class="btn btn-primary"><i class="fa-solid fa-file-pdf fa-2x"></i></buttom>',e+="</td>",e+="</tr>",e+='<div class="modal fade" id="exampleModalVer'+t.id+'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">',e+=' <div class="modal-dialog modal-dialog-centered">',e+=' <div class="modal-content">',e+=' <div class="modal-header bg-black ">',e+=' <h5 class="modal-title text-white" id="exampleModalLabel">Metadatos del Documento <strong>'+t.codigo+"</strong></h5>",e+='<button type="button" class="btn text-white" style="font-size:13px" data-bs-dismiss="modal" aria-label="Close"><i class="fa-solid fa-x fa-lg"></i></button>',e+=" </div>",e+='  <div class="modal-body">';let l=JSON.parse(t.keywords),n=JSON.parse(t.data);e+="<p><strong>KEYWORDS</strong></p>",e+="<p>"+l.keywords+"</p>",console.log("datos",n),n.forEach(t=>{e+="<p><strong>"+t.nombre.toUpperCase()+"</strong></p>",e+="<p>"+t.valor+"</p>"}),e+="  </div>",e+=' <div class="modal-footer">',e+=' <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>',e+="  </div>",e+="</div>",e+="</div>",e+="</div>"}),e+="</tbody>",e+="</table>",document.getElementById("dibujar-tabla").innerHTML=e,$("#tablaDocs").DataTable())}function abrirPdf(e,t){window.open(URL_BASE+e,t,"width=620,height=400,fullscreen=yes,scrollbars=NO"),parent.opener=top,opener.close()}function traerDocs(e){return new Promise((t,a)=>{let o=[];$.ajax({data:{id:e,tipo:"documentos"},url:URL_BASE+"/documentos/datos",type:"POST",headers:{token:token},dataType:"json"}).done(e=>{e.exit&&Swal.fire({icon:"warning",title:e.exit,showConfirmButton:!1,text:"Sesión expirada, vuelva a iniciar sesión",timer:3e3}).then(()=>{window.location.href=URL_BASE+"/?r=8"}),0==e.length&&t(0),$.each(e,(a,s)=>{o.push(s),console.log(e),e.length==a+1&&t(o)})}).fail(e=>{a(e)})})}document.addEventListener("DOMContentLoaded",iniciarApp());